; CALIBRACION : AJUUSTAR A 2,2 EN PATA 2 DEL LM358 CON POT DE 10K Nº 48
; AJUSTAR CON EL POT DE 1Mh Nº 57  LA INTENSIDAD DEL EQUIPO
; AJUSTAR CON EL POT 10K Nº 21 LA CONCENTRACION DE SAL
; CON UNA TENSION DE 1,60 EN PATA 4 DEBE MARCAR 6,2
; RUTINA MED_SAL EL RESULTADO EN R4
PRO3D1B: 			; ACTIBA EL PILOTO DE SAL BAJA
	LDI				R25,1
	STS				0XB06,R25				; PONE EN 0XB06 UN 1
	RJMP			PRO3D

PRO3D1A:		;	PRESENTACION DE AVERIA EN FUENTE O RELE
	LDI				R19,240			; SEGUNDOS DE RETARDO
	CALL			RUT_RETARDO			; SI NO HAN PASADO SIGUE CONTANDO
;	CLR				LEC_REL
PRO3D1AA: ;RUTINA DE RETARDO PARA LE PRESENTACION DEL ERROR 
	LDS				R26, RAMC_SAL		; NUMERO DE MEDICIONES
	LDI				R18,P_SAL			; LINEA DE ENTRADA EN EL CONVERTIDOR
	CALL			ADC_P
;	LDS				R18,RAM_MED_INI_SAL	; CARGA EL ERROR INICIAL DEL TLC26 EN R18
;	SUB				R24,R18				; RESTA EL ERROR INICIAL DE LA MEDICION
PRO3D1AB:
	SBRC			R24,7				; SALTA LA SIGUIENTE INSTRUCION SI EL BIT 7 DE R24 ES CERO OSEA MENOR DE 126
	LDI				R24,00				; LO PONE A CERO POR HABER DADO LA VUELTA
	CPI				R24,8				; SI LA MEDICION REAL ES MENOR DE 0,8 7+1 para evitar la repeticion ciclica NO EJECUTA LA SIGUIENTE INSTRU
	BRBC			0, PRO3_NEXTION				; FALSO ERROR MEDICION MAYOR DE 7

; RUTINA ESCRITURA LINEA2 EN CASO DE ERROR EQUIPO DETENIDO AVERIA Y PAGINA ERROR DE NEXTION LA 4
		LDI			R16,52				; ESCRIBE EN RAM LA PAGINA A ENVIAR LA 04
		STS			0xA01,R16
		CALL		P_NEXTION_PAGE		; TERMINA EL TIEMPO Y VA A PANTALLA PRINCIPAL

	CALL			VER_ERROR
	CALL			APAGAR_FUENTE
	CBI				PORTD,b_acido		; APAGA BOMBA DE ACIDO
	MOV				R16, VAL_LED
	ANDI			R16, 0B11111110		; APAGA LED 0 FUENTE ENCENDIDA
	MOV				VAL_LED, R16	
	CALL			LEDPANT
	RJMP			PRO3CA4			



PRO3D2A_1: 			; PARA SALTAR MAS VA A RUTINA VERIFICACION DE CAUDAL 
	JMP				CONTROL_CAUDAL		; EL RETORNO SE HACE A PRO3D

PRO3_NEXTION:				; PARA IR A LA PAGINA PRINCIPAL

		LDI			R16,48				; ESCRIBE EN RAM LA PAGINA A ENVIAR LA 00
		STS			0xA01,R16
		CALL		P_NEXTION_PAGE		; VA A PANTALLA PRINCIPAL


PRO3:				; PARA MEDIR LA SAL DEL AGUA AQUI EMPIEZA
	WDR

;	LDI				R16,0x2E			; SE PONE UN VALOR FIJO PARA MEDIR LA  SAL 70% DE PRODUCCION 0x02E
;	STS				OCR3AH,R16
;	LDI				R16,0x2E
;	STS				OCR3AL,R16	
	; VALOR DE MEDICION TOTAL	
	LDI				R18,P_SAL			; LINEA DE ENTRADA EN EL CONVERTIDOR PCF8591
	LDS				R26, RAMC_SAL		; NUMERO DE MEDICIONES	
	CALL			ADC_P
;LDI R24,54			;******************************* ********************************************************************
	STS				SAL_UART,R24
PRO3C:
	CPI				R24,06				; SI LA MEDICION REAL ES MENOR DE 0,6 SALTA DIRECTAMENTE
	BRBS			0,PRO3D1A			; VA A RETARDO CUENTA 240 SEGUNDOS
	CPI				R24,15				; PARA ENVIAR MENSAJE DE SAL BAJA		
	BRBS			0,PRO3D1B			; ACTIBA EL PILOTO DE SAL BAJA RETORNA A PRO3D
; ELIMINADA LA OPCION DE CONTROL CAUDAL POR BAJA PRODUCION
;	CPI				R24, 20
;	BRBS			0, PRO3D2A_1		; VA A PUENTE DE SALTO Y RETORNA A PRO3D
;	LDI				R18, 10				; PONE EL CONTADOR DE SEGUNDOS A 10
;	STS				RAM_CAUDAL, R18		; LIMPIA DE SEGUNDOS EL CONTROL DE CAUDAL ENPIEZA EN 10 SEGUNGOS

PRO3D: ;Grabar el valor en RAM Ó NO
	MOV				R16, R24			; PASA EL VALOR DE LA LECTURA A R16
	CALL			RADC				; PRESENTA EN LINEA 3 LA MEDICION DE SAL REAL
	STS				$254, R1			; DECENAS
	STS				$255, R2			; UNIDADES
	STS				$257, R3			; DECIMAS	
	STS				$904,R1				; PONE EN PANTALLA CALIBRAR SAL
	STS				$905,R2				; PONE EN PANTALLA CALIBRAR SAL
	STS				$907,R3				; PONE EN PANTALLA CALIBRAR SAL

; ACTUALIZA LA SAL SIN AMORTIGUADOR
	CPI				LEC_REL, 5			; SI NO SON 5 EJECUTA LA PROXIMA INSTRUCION
	BRNE			PRO3A1				; Y SALTA A PRO3A1 PARA NO GRABAR DIRECTAMENTE LA SAL REAL MEDIDA
	STS				RAM_SAL, R16		; ALMACENA EN LA MEMORIA RAM
	STS				RAM_SAL_C, R16		; ALMACENA LA MEDICION EN LA MEMORIA RAM
PRO3A1:
; AQUI INCREMENTA EL VALOR DE R24
	LDS				R24, RAM_SAL		; LEE EL VALOR GRABADO EN RAM
	INC				R24					; INCREMENTO EN UNA UNIDAD 
	INC				R24
	CP				R16, R24			; LO COMPARA CON EL VALOR ULTIMO LEIDO
	BRCS			PRO3D1				; SI NO ES MAYOR DE DOS DECIMAS NO LO ALMACENA
	DEC				R24
	STS				RAM_SAL, R24		; ALMACENA LA MEDICION EN LA MEMORIA RAM
	STS				RAM_SAL_C, R24
	RJMP			PRO3D2				; SALTA A PRO3D2 COMPENSACION POR TEMPERARURA
PRO3D1:
	SUBI			R24,4
	CP				R24,R16				; Y LO VUELVE A COMPARAR CON EL ALMACENADO
	BRCS			PRO3D2				; SALTA A PRO3D2
	INC				R24
	STS				RAM_SAL, R24		; ALMACENA LA MEDICION EN LA MEMORIA RAM
	STS				RAM_SAL_C, R24		; 
PRO3D2:		; COMPENSACION POR TEMPERATURA
	LDS				R18, RAM_TEMP
	LDI				R25, 10
	RCALL			COMP				; COMPRUEBA SI ES MAYOR DE 4 GRADOS
	SBRS			CONTROL, 0			; VERIFICA SI ES CERO EL BIT 0 SI ES CIERTO SALTA LA SIG. INSTRUCION
	RJMP			PRO3D2C				; POR SI NO HAY SONDA PT1000  O LA TEMP. ES MAYOR DE 35ºC
	LDI				R25, 80
	RCALL			COMP
	SBRC			CONTROL, 0			; VERIFICA SI ES CERO EL BIT 0 SI ES CIERTO SALTA LA SIG. INSTRUCION
	RJMP			PRO3D2C				; POR SI NO HAY SONDA PT1000  O LA TEMP. ES MAYOR DE 35ºC
	CBR				CONTROL, 0B00000100	; SEÑAL DE CONTROL EN VERANO INVIERNO A CERO
; COMPENSACION DE LA LECTURA DE SAL EN FUNCION DE LA TEMPERATURA
	LDS				R24, RAM_SAL		; CARGA EN R24 EL VALOR LEIDO DE LA SAL
	LSL				R24					; LO MULTIPLICA POR DOS JE JE
	SUB				R25, R18			; RESTA A R25 QUE ES 70 LA TEMPERATURA REAL
	LSL				R25					; MULTIPLICA POR 2
	LDI				R19, 128 - 72
	ADD				R25, R19
	MUL				R25, R24
	MOV				R24, R1
	STS				RAM_SAL_C, R24		; ALMACENA LA MEDICION EN LA MEMORIA RAM
PRO3D2C:
 	SBRC			CONTROL, 3			; SALTA LA PROXIMA INSTRUCION SI ES CERO, NO SUPERCLORACION
	RJMP			PRO3D2A				; LA SALTA SI NO ESTA EN SUPERCLORACION
	CPI				R24, lim_sal		; LIMITE DE SAL  MENSAJE " AÑADIR SAL" " -.- kG/M3"
	BRBS			0,PRO3CA			; SI ES MAYOR DE 15 NO VA
	SET									; PONE ES REGISTRO T A 0 SET LO PONE A 1
	BLD				CONTROL_1, 5		; PASA EL REGISTRO T A CONTROL_1

PRO3D2A:
	RET
PRO3D2B:	; GRABA LA NUEVA MEDICION DE SAL PARA PODER VERIFICAR SI VARIA
	STS				RAM_SAL_CORTE, R24
	RET

; PRESENTACION EN PANTALLA DE ERROR EN CONCENTRACION DE SAL EN EL AGUA, CONCENTRACION BAJA
; INDICA GRAMOS POR LITRO A AÑADIR
PRO3CA:
	WDR									; ACTUALIZA EL PERRO GUARDIAN
	SBRS			LEC_REL, 1			; TEMPORIZA A 2 SEGUNDOS
	RET

PRO2CA4: ; RETORNO DE ERROR_2
	LDS				R25, RAM_SAL_CORTE	; LEE EL VALOR ANTERIOR PARA COMPARARLO CON EL NUEVO
	CP				R24, R25
	BRNE			PRO3D2B				; SALTA SI SON DISTINTOS LOS VALORES			
	; SI SON IGUALES PRESENTA EN PANTALLA ERROR Y VALOR DE SAL A AÑADIR
	LDI				R25, 63				; CANTIDAD A LA QUE RESTAR
	SUB				R25, R24			; LA MEDICION DE SAL
	MOV				R24, R25			; LA MUEVE A R24 PARA CONVERTIRLA EL UNIDADES Y DECIMAS
	SUBI			R24, 3
	RCALL			RADC
	STS				$05BB, R2			; GRABA EN RAM LAS UNIDADES
	STS				$05BD, R3			; GRABA EN RAM LAS DECIMAS
; CAMBIA EL MENSAJE SI LA CONCENTRACION ES NULA
	LDI				R25, 0x05			
	LDS				R24, RAM_SAL_CORTE	; VA A ERROR ELECTRODO POR SER LA MEDIDA DE SAL MENOR DE 0,5
	CP				R24, R25
	BRGE			PRO3CA3_1			; SI ES MENOR O IGUAL SALTA "FALLO ELECTRODO", "AVERIA"
	RCALL			PRO3D1A				; RUTINA AVERIA FALLO ELECTRODO EQUIPO DETENIDO

PRO3CA3_1:
	CLT									; PONE ES REGISTRO T A 0 SET LO PONE A 1
	BLD				CONTROL_1, 5		; PASA EL REGISTRO T A CONTROL_1
	RET

;PRO3CA3:  ; RUTINA AÑADIR SAL; TEXTO "AÑADIR SAL" 1ª LINEA
	LDI				R16, 128			; SI NO SIGUE EN FALLO REJILLA
	CALL			ENVINT				; Y ENVIA EN MANSAJE A PANTALLA 1º INFORMACION DE LINEA Y....
	LDI				YH,HIGH (LIN_REJILLA) ; POSICION BIT ALTA DEL TEXTO A ENVIAR A PANTALLA "AÑADIR SAL"
	LDI				YL, LOW (LIN_REJILLA) ; POSICION BIT BAJA DEL TEXTO A ENVIAR A PANTALLA
	LDI				R17, 20				; NUMERO DE DIGITOS A ENVIAR A PANTALLA
	RCALL			ENVIARTEXTO			; 2º EL TEXTO 16 CARACTERES
; TEXTO "-.- KG/M3" 1ª LINEA  Y 2ª LINEA "EQUIPO DETENIDO"
	WDR
	LDI				R16, 148			; ESCRIBE LINEA 3 
	CALL			ENVINT				; Y ENVIA EN MANSAJE A PANTALLA 1º INFORMACION DE LINEA Y....
	LDI				YH,HIGH (A_SAL) 	; POSICION BIT ALTA DEL TEXTO A ENVIAR A PANTALLA "-.- GR/LITRO"
	LDI				YL, LOW (A_SAL)		; POSICION BIT BAJA DEL TEXTO A ENVIAR A PANTALLA
	LDI				R17, 20				; NUMERO DE DIGITOS A ENVIAR A PANTALLA
	RCALL			ENVIARTEXTO			; 2º EL TEXTO 16 CARACTERES
	RET

PRO3CA4: ; PONEEN PANTALLA Y BORRA LINEA 3 Y 4

	LDI				R16, 128			; 11000000 escribir en linea 2 linea (192)( linea 4 seria 212)
	CALL			ENVINT				; RUTINA PARA ENVIAR A LA PANTALLA UNA INSTRUCION, " ESCRIBIR LINEA 2"
	LDI				YH, HIGH (LIN_2S)	; POSICION ALTA DEL TAXTO EN RAM 080
	LDI				YL, LOW  (LIN_2S)	; direccion BAJA DEL TEXTO EN RAM  "EUIPO DETENIDO"    	
  	LDI				R17,20   			; bytes a enviar 
	CALL			ENVIARTEXTO			; RUTINA PARA ENVIAR TEXTO E PANTALLA
	LDI				R16, 192			; 11000000 escribir en linea 2 linea (192)( linea 4 seria 212)
	CALL			ENVINT				; RUTINA PARA ENVIAR A LA PANTALLA UNA INSTRUCION, " ESCRIBIR LINEA 2"
	LDI				YH, HIGH (AVERIA)	; POSICION ALTA DEL TAXTO EN RAM 080
	LDI				YL, LOW  (AVERIA)	; direccion BAJA DEL TEXTO EN RAM  "CONSULTAR MANUAL"    	
  	LDI				R17,20   			; bytes a enviar 
	CALL			ENVIARTEXTO			; RUTINA PARA 
	LDI				R16, 148			; 11000000 escribir en linea 2 linea (192)( linea 4 seria 212)
	CALL			ENVINT				; RUTINA PARA ENVIAR A LA PANTALLA UNA INSTRUCION, " ESCRIBIR LINEA 2"
	LDI				YH, HIGH (BORRAR_LINEA)	; POSICION ALTA DEL TAXTO EN RAM 080
	LDI				YL, LOW  (BORRAR_LINEA)	; direccion BAJA DEL TEXTO EN RAM  "CONSULTAR MANUAL"    	
  	LDI				R17,20   			; bytes a enviar 
	CALL			ENVIARTEXTO			; RUTINA PARA 
	LDI				R16, 212			; 11000000 escribir en linea 2 linea (192)( linea 4 seria 212)
	CALL			ENVINT				; RUTINA PARA ENVIAR A LA PANTALLA UNA INSTRUCION, " ESCRIBIR LINEA 2"
	LDI				YH, HIGH (BORRAR_LINEA)	; POSICION ALTA DEL TAXTO EN RAM 080
	LDI				YL, LOW  (BORRAR_LINEA)	; direccion BAJA DEL TEXTO EN RAM  "CONSULTAR MANUAL"    	
  	LDI				R17,20   			; bytes a enviar 
	CALL			ENVIARTEXTO			; RUTINA PARA 

		LDI			R16,53				; ESCRIBE EN RAM LA PAGINA A ENVIAR LA 05
		STS			0xA01,R16
		CALL		P_NEXTION_PAGE		; PAGINA DE TEXTO NEXTION A V E R I A



LDS			R16,S_FUENTE		; VERIFICA LA TENSION DE LA FUENTE
CPI			R16,30
BRLO		AV_FUENTE			; SI ES MENOR VA A AVERIA EN FUENTE
LDI			R16,1
STS			AVERIA_CPU,R16		; POSICION B09 EN RAM
RJMP		AV_FUENTE_N
AV_FUENTE:
LDI			R16,1
STS			AVERIA_FUENTE,R16	; POSICION B08 EN RAM
AV_FUENTE_N:
CALL		CADENA_UART
PRO3D1A_1:
	RJMP			PRO3D1A_1
