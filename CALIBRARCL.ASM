;  RUTINA CALIBRAR RD Y CL
; RUTIMA PARA LA MEDICION DE LA CONCENTRACION DE RD EN EL AGUA Y PROTECCION DE LA FUENTE
; SE ACTIVA CON LAS TECLA + - Y PROGRAMACION


PRO7:	; PARA AJUSTAR LA RD DEL AGUA
	LDS				R31,RAMC_CL		; VALOR PARA EL CALIBRADO DEL CL
	LDS				R27,RAMC_RD		; VALOR PARA EL CALIBRADO DEL RD
	LDI				R22,00
	CLR				R7					; PONE A CERO EL RETARDO SALIDA TECLADO
PRO7A:
	CPI				R22,30				; VALOR DEL TIEMPO DE RATARDO LECTURA DEL TECLADO
	BRLO			PRO7A				; COMPRUEBA EL TIEMPO DE RETARDO 
;	SBI				PORTB,0				; ENCIENDE LA FUENTE
	WDR
	CLR				R24
	; VALOR DE MEDICION TOTAL RD	
	LDI				R18,P_RD			; LINEA DE ENTRADA EN EL CONVERTIDOS PCF8591
	MOV				R26,R27			; NUMERO DE LECTURAS Ó CALIBRACION REDOX
;	RCALL			PCF					; RUTINA MEDICION PCF8591
	RCALL			ADC_P
	SUBI			R24,46
	STS				RAM_RD,R24			; ALMACENA LA MEDICION EN LA MEMORIA RAM
	; VALOR DE MEDICION TOTAL CL	
	WDR
	CLR				R24
	LDI				R18,P_CL			; LINEA DE ENTRADA EN EL CONVERTIDOS PCF8591
	MOV				R26,R31			; NUMERO DE LECTURAS Ó CALIBRACION CLORO
;	RCALL			PCF
	RCALL			ADC_P
	SUBI 			R24,60				; AJUSTE CONVERTIDOR APERACIONAL CERO DE CLORO 60 EN DIGITAL
	LSR				R24					; DIVIDIMOS ENTRE DOS
	LSR				R24					; DIVIDIMOS ENTRE DOS TOTAL 4
	STS				RAM_CL,R24			; GRABA EL VALOR EN RAM
	RCALL			LINEACL				; PRESENTACION EN PANTALLA	
	CALL			LEC_TEC
	CPI				R17,0B11111101		; TECLA + INCREMENTA EL VALOR AJUSTE CL	
	BREQ			BAJAR_RD
	CPI				R17,0B11101111		; TECLA - REDUCIR VALOR AJUSTE CL 
	BREQ			SUBIR_RD
	CPI				R17,0B11110101		; TECLA +  Y  PROG INCREMENTA EL VALOR AJUSTE RD
	BREQ			BAJAR_CL
	CPI				R17,0B11100111		; TECLA -  Y  PROG REDUCIR VALOR AJUSTE DE RD
	BREQ			SUBIR_CL
	CPI				R17,0B01111111		; TECLA SALIR
	BREQ			RDIR_CL
	MOV				R24,TEMP_TEC
	CPI				R24,50				; PARA COMPARARLO CON EL RETARDO SIN PULSAR TECLA
	BRPL			RDIR_CL1			; Y RDIR DE PROGRAMACION DE PARAMETROS
	RJMP			PRO7A
BAJAR_CL:
	CLR				R7					; PONE A CERO EL RETARDO SALIDA TECLADO
	DEC				R31
	DEC				R31
	DEC				R31
	LDI				R22,00
	CPI				R31,150
	BRBC			0,BAJAR_CL1 
	LDI				R31,151
	LDI				R22,00
	RJMP			PRO7A
BAJAR_CL1:
	LDI				R22,00
	RJMP			PRO7A
SUBIR_CL:
	CLR				R7					; PONE A CERO EL RETARDO SALIDA TECLADO
	INC				R31
	INC				R31
	INC				R31
	LDI				R22,00
	CPI				R31,250				; MINUTOS POR CICLO ( INVIERTE)
	BRBS			0,SUBIR_CL1		; SI MAYOR SALTA A SUBIR_CL1 Y PONE R31 CON EL VALOR MASIMO
	LDI				R31,250
;	LDI				R22,00
	RJMP			PRO7A			
SUBIR_CL1:
	LDI				R22,00
	RJMP			PRO7A
; AJUSTE CALIBRACION CONCENTRACION DE RD
BAJAR_RD:
	CLR				R7					; PONE A CERO EL RETARDO SALIDA TECLADO
	DEC				R27
;	DEC				R27
	LDI				R22,00
	CPI				R27,200
	BRBC			0,BAJAR_RD1 
	LDI				R27,201
;	LDI				R22,00
	RJMP			PRO7A
BAJAR_RD1:
;	LDI				R22,00
	RJMP			PRO7A
SUBIR_RD:
	CLR				R7					; PONE A CERO EL RETARDO SALIDA TECLADO
	INC				R27
;	INC				R27
	LDI				R22,00
	CPI				R27,254				; VALOR MAXIMO DE NUMERO DE VECES DE LECTURA.
	BRBS			0, SUBIR_RD1		; SI MAYOR RDTA A SUBIR_CL1 Y PONE R31 CON EL VALOR MAXIMO
	LDI				R27,253
;	LDI				R22,00
	RJMP			PRO7A			
SUBIR_RD1:
;	LDI				R22,00
	RJMP			PRO7A

RDIR_CL:  ; GRABA LOS NUEVOS VALORES EN LA REM Y EEPROM
	STS				RAMC_CL,R31 		; GRABA EN LA EL NUEVO VALOR DEL CALIBRADO DE CL
	STS				RAMC_RD,R27			; GRABA EN LA EL NUEVO VALOR DEL CALIBRADO DE RD
 	LDI				R17,CLC_MEN			; POSICION DEL CL PROGRAMADO EN EEPROM $000
	MOV				R18,R31
	RCALL			EEPROM_ES
	LDI				R17,RDC_MEN			; POSICION DE MEMORIA A LEER EN EEPROM $005
	MOV				R18,R27 
	RCALL			EEPROM_ES
	MOV				R16,VAL_LED			; APAGA LUZ PANTALLA
	ANDI			R16,0B10111111
	MOV				VAL_LED,R16
	RCALL			LEDPANT				; ACTUALIZAR LOS LED DE LA PANTALLA	
	RCALL			NO_TECLA
	RET
RDIR_CL1:  ; RDE SIN GRABAR LOS VALORES
	MOV				R16,VAL_LED			;APAGA LUZ PANTALLA
	ANDI			R16,0B10111111
	MOV				VAL_LED,R16
	RCALL			LEDPANT				; ACTUALIZAR LOS LED DE LA PANTALLA	
	RET
LINEACL: ; RUTINA ESCRITURA LINEASP
	LDI				R16,67				; ESCRIBE UN C
	STS				$101,R16
	LDI				R16,108				; PONE UNA l
	STS				$102,R16	
	LDI				R16,67				; PONE UNA C
	STS				$103,R16
	LDI				R16,46				; PONE UN .
	STS				$106,R16	
	LDI				R16,32				; CODIGO DEL ESPACIO			
	STS				$100,R16
	STS				$104,R16
	STS				$108,R16
	STS				$109,R16
	STS				$10C,R16
	STS				$10D,R16
	LDS				R24,RAM_RD			; CARGA DE LA RAM EL VALOR DE LA MEDICION DE LA RD
	RCALL			RADC5I				; RUTINA ESPECIAL PARA CONVERTIR EL REDOX EN BCD
	LDI				R16,82				; PONE UNA R
	STS				$10A,R16
	LDI				R16,100				; PONE UNA d
	STS				$10B,R16
	LDI				R16,67				; PONE UNA C
	STS				$10C,R16
	STS				$10E,R1
	STS				$10F,R2	
	STS				$110,R3		
	LDS				R24, RAM_CL
	RCALL			RADC
	STS				$105,R2
	STS				$107,R3			
	LDI				R16,192			; 11000000 escribir en linea 2 linea (192)( linea 4 seria 212)
	RCALL			ENVINT
	LDI				YH,HIGH (LIN1)	; POSICION ALTA DEL TAXTO EN RAM 080
	LDI				YL,LOW  (LIN1); direccion BAJA DEL TEXTO EN RAM      	
  	LDI				R17,20 			; bytes a enviar 16 POR LINEA
	RCALL			ENVIARTEXTO		; RUTINA PARA ENVIAR TEXTO A PANTALLA
	RET
; linea 1-128
; linea 2-192
; linea 3-148
; linea 4-212

