; SALIDA 1,72 CON PH 7 Y 2,07 CON PH 3,8
; opto		pata2		pata3
; ph 7.0	 0,97		  0,76
; ph 3.8	 1.02		  0,76

;		RUTINA MED_PH
; PINB,7 SELECCIONA SUBIR O BAJAR PH SIN PUENTE BAJAR


PRO2F2: ; APAGA BOMBA DE PH Y LED EN ESTE CASO ES POR DEFECTO DE SONDA
	STS				RAM_PH, R16
	MOV				R16, VAL_LED
	ANDI			R16, 0B11101111		; APAGA LED 4 PH EN PANTALLA
	MOV				VAL_LED, R16
	CBI				PORTD,b_acido		; APAGA BOMBA DE ACIDO
	LDI				R16,69				; PONE UNA E "ERROR DE SONDA"
	STS				$46D,R16
	LDI				R16,83				; PONE UNA S "ERROR DE SONDA"
	STS				$46F,R16
	LDI				R16,32
	STS				$46C,R16
VOLVER:
	RET

PRO2:	; PARA MEDIR EL PH
	WDR
	LDI				R18, P_PH				; LINEA DE ENTRADA EN EL CONVERTIDOR PCF8591
	LDI				R26,231				; NUMERO DE LECTURAS Ó CALIBRACION
	CALL			ADC_P
;RCALL RADC
;STS				$131, R1
;STS				$132, R2
;STS				$133, R3
;*****************************************PARA MOSTRAR EL PH SIN SONDA*******************************************************
;LDI R24,148  ; PH FIJO A 7.3

	LDI				R16, 15				; VALOR MINIMO NO SE DETECTA SONDA DE Ph
	CP				R24, R16
	BRSH			PRO2D				; SALTA PRO5D SI EL MODULO ESTA CONECTADO
	CBR			CONTROL, 0B00010000		; LINEA DE CONTROL SIN SONDA DE Ph SOLO PRESENTA LINEA DE PRODUCION Y SAL
	CBI				PORTD,b_acido		; APAGA BOMBA DE ACIDO
	RET
; TIENE QUE SER EL VALOR LEIDO + Ó - DOS UNIDADES PARA QUE SE GRABE EN LA RAM

PRO2D:
	SBR				CONTROL, 0B00010000	; LINEA DE CONTROL LA PONE A 1 TIENE SONDA DE PH
	LDS				R19, MINU
	CPI				R19, 01				; VERIFICA QUE HAN PASADO DOS MINUTO PARA EMPEZAR A MEDIR
	BRBS			0, VOLVER			; SI ES MENOR DE DOS MINUTOS SALTA A VOLVER
	LDI				R16, 216			; RESTA 10 PARA LUEGO SUMERLE LA CALIBRACION ENTRE 0 Y 20
	SUB				R16, R24			; Y RESTANDOLO DEL LEIDO			
	LDS				R19, RAMC_PH		; LEE EL VALOR DE CALIBRACION que suele ser 10
	ADD				R16, R19			; SE LA SUMA AL LEIDO
	CPI				R16, 120
	BRBC			0, PRO2F2			; APAGA BAMBA DE PH Y LED PANTALLA POR FALLO EN SONDA			
	MOV				R24, R16
	CPI				LEC_REL, 2			; SI NO SON 5 EJECUTA LA PROXIMA INSTRUCION
	BRNE			PRO2DA1				; Y SALTA A PRO3A1 PARA NO GRABAR DIRECTAMENTE PH REAL MEDID0
	STS				RAM_PH, R16
PRO2DA1:

	LDI				R24, 46				; PONE EL PUNTO DEL PH
	STS				$25E, R24
	STS 			PH_REAL, R16
	LDS				R24, RAM_PH			; LEE EL VALOR GRABADO EN RAM Y AMORTIGUADO
	ADIW			R24, 2				; INCREMENTO EN DOS UNIDADES Y
	CP				R16, R24			; LO COMPARA CON EL VALOR ULTIMO LEIDO
	BRLT			PRO2D1				; SI NO ES MAYOR DE DOS DECIMAS NO LO ALMACENA
	DEC				R24
	STS				RAM_PH, R24			; ALMACENA LA MEDICION EN LA MEMORIA RAM
	RJMP			PRO2D2
PRO2D1:
	SUBI			R24, 4
	CP				R24,R16				; Y LO VUELVE A COMPARAR CON EL ALMACENADO
	BRLT			PRO2D2
	INC				R24
	STS				RAM_PH, R24			; ALMACENA LA MEDICION EN LA MEMORIA RAM
PRO2D2:
LDS R24,RAM_PH
	RCALL			RADC				; PONER VALOR REAL PH EN LINEA 2
	STS				$46C,R1
	STS				$46D,R2				; COLOCA EN PANTALLA NORMAL LAS UNIDADES
	STS				$46F,R3				; COLOCA EN PANTALLA NORMAL LAS DECIMAS DE PH
	STS				$918,R1				; COLOCA EN PANTALLA CALIBRACION LAS DECENAS
	STS				$919,R2				; COLOCA EN PANTALLA CALIBRACION LAS INIDADES
	STS				$91B,R3				; COLOCA EN PANTALLA CALIBRACION LAS DECIMAS

LDS R24,RAMP_PH
	RCALL			RADC				; PONER VALOR DEL PH PROGRAMADO EN LINEA 2
;	STS				$45F, R1
	STS				$460, R2			; PONE EN PANTALLA NORMAL LAS UNIDADES DE PH PROGRAMADO
	STS				$462, R3			; PONE EN PANTALLA NORMAL LAS DECIMAS DE PH PROGRAMADO
	STS				$96B, R2			; COLOCA EN PANTALLA PROGRAMACION LAS UNIDADES
	STS				$96D, R3			; COLOCA EN PANTALLA PROGRAMACION LAS DECIMAS
LDI	R18,46 ;COLOCA UN PUNTO
STS	$96C,R18
STS $91A,R18
	LDS				R19, RAM_PH			
	LDS				R18, RAMP_PH
; APAGA BOMBA DE PH SI EL VALOR LEIDO ES MAYOR DE 9.0 POSIBLE AVERIA APAGA BOMBA
	LDI				R24,91				; VALOR MAX. DEL PH PARA APAGAR BOMBA DOSIFICADORA DE PH
	CP				R19,R24				; SI R19 ES MENOR QUE R24 VA A PRO2A
	BRLT			PRO2E				; SI NO ES MAYOR R19 QUE R24 NO SALTA A PRO2E SEGUIMOS
	RJMP			PRO2F1				; APAGA LED Y BOMBA DE PH
PRO2E:
;APAGAR BOMBA DE PH DESPUES DE X MINUTOS/hora
	LDS  			R25, minu			; CARGA LOS MINUTOS BOMBA ENCENDIDA
	LDI				R24, 60				; CARGA EL TIEMPO DE FUNCIONAMIENTO DE LA BOMBA
	CP				R25, R24
	BRLO			PRO2E1				; VA A PRO2E1 SI R25 ES MENOR QUE R24
	RJMP			PRO2F1				; APAGA LED Y BOMBA DE PH
PRO2E1:
; VERIFICAR NIVEL DE ACIDO
	SBRC			VAL_LED, 5			; VERIFICA EL LED 5 FALTA DE NIVEL EN EL DEPOSITO
	RJMP			PRO2F1				; Y SALTA ESTA INSTRUCION SI ES UNO "HAY NIVEL" PAGA LED Y BOMBA DE PH
; OPCION PROPORCIONAL A 8 CICLOS Y DETECCION OPCION SUBIR O BAJAR PH
PRO2E2:
	ANDI			R25, 7				; ELIMINA LOS BIT 3-4-5-6-7 DEL REGISTRO DE CICLOS HORA
; OPCION SUBIR O BAJAR PH ENTRADA DE SEÑAL EN PINB,7
	IN				R6, PINB			; VERIFICA SI HAY PUENTE EN PIND3 CON NEGATIVO
	SBRC			R6, 7				; EN CUYO CASO VA A PRO2E SUBIR PH
	RJMP			PRO2E4				; OPCION BAJAR PH
PRO2E3: ; OPCION SUBIR PH
	LDS				R19, RAM_PH			
	LDS				R18, RAMP_PH
	INC				R19
	SUB				R18, R19
	SBRC			R18, 7				; VERIFICA SI HAY DESBORDAMIENTO
	RJMP			PRO2F1				; EN CUYO CASO APAGA LA BOMBA DE PH
	LSL				R18
	CP				R18, R25
	BRLO			PRO2F1
	RJMP			PRO2H				; APAGA LED Y BOMBA DE PH

PRO2E4: ; OPCION NORMAL BAJAR PH
	LDS				R19, RAM_PH			
	LDS				R18, RAMP_PH
	INC				R18					; INCREMENTA EN UNO PARA QUE PARE EN CASO DE SER IGUALES
	SUB				R19, R18
	SBRC			R19, 7				; VERIFICA SI HAY DESBORDAMIENTO
	RJMP			PRO2F1				; EN CUYO CASO APAGA LA BOMBA DE PH
	LSL				R19					; MULTIPLICA POR 2
	CP				R19, R25
	BRLO			PRO2F1				; ENCIENDE BOMBA DE PH
	RJMP			PRO2H
PRO2F1: ; APAGA BOMBA DE PH Y LED
	MOV				R16, VAL_LED
	ANDI			R16, 0B11101111		; APAGA LED 4 PH EN PANTALLA
	MOV				VAL_LED, R16
	CBI				PORTD,b_acido		; APAGA BOMBA DE ACIDO


	RET
PRO2H: ;ENCIENDE BOMBA DE PH Y LED
	MOV				R16, VAL_LED
	ORI				R16, 0B00010000		; ENCIENDE LED 4 PH EN PANTALLA
	MOV				VAL_LED, R16	
	SBI				PORTD,b_acido		; ENCIENDE BOMBA DE ACIDO

		CALL		P_NEXTION_FINAL 	; ENVIA 3 0xFF

	RET
