; RUTINA DEL TECLADO PARA AJUSTE DEL REDOX

; TECLA 0 PROGRAMAR
; TECLA 1 MENOS
; TECLA 2 FLECHA
; TECLA 3 CALIBRAR
; TECLA 4 MAS
; TECLA 5 
; TECLA 6 NIVEL ACIDO
; TECLA 7 SALIR


TECLA2T:

	STS			RAMP_RD, R30		; ACTUALIZA EN RAM EL NUEVO VALOR PROGRAMADO DEL PH
	LDI			R17, RD_MEN
	MOV			R18, R30			; GRABA EL VALOR DEL REDOX EN EEPROM 242
;	RCALL		I2CE_2404			; ESCRIBE EL NUEVO VALOR EN LA EEPRON EXTERNA
	RCALL		EEPROM_ES	
RCALL PRO5		; PARA EVITAR EL ERROR EN FUENTE LA ENCIENDE SI ES MAYOR EL VALOR DE REDOX
	MOV			R16, VAL_LED
	ANDI		R16, 0B10111111
	MOV			VAL_LED, R16
	RCALL		LEDPANT				; ACTUALIZAR LOS LED DE LA PANTALLA	
	RCALL		NO_TECLA
	RET
TECLACL_RD:		; PROGRAMACION DEL VALOR PARA EL APOYO DE CLORO DOSIFICACION
STS RAMP_RD,R30
CALL TECLA6V ;***************  VA A PROGRAMAR VALOR DEL APOYO DE REDOX
TECLA2V:
	CPI			R22, RETARDO1
	BRLO		TECLA2V
	LDS			R30, RAMP_RD		; CARGA DE LA RAMM EL VALOR DE REDOX PROGRAMADO
	LDI			R22, 00

TECLA2:								; AJUSTAR PH VALOR EN R30
	WDR
	MOV			R24, TEMP_TEC
	CPI			R24, retardo_programacion	; PARA COMPARARLO CON EL RETARDO 20 SEGUNDOS SIN PULSAR TECLA
	BRPL		TECLA2T						; Y SALIR DE PROGRAMACION DE PARAMETROS										RDO 20 SEGUNDOS SIN PULSAR TECLA
	CALL		LEC_TEC
	CPI			R17, 0B11111111		; COMPRUEBA SI SE A PULSADO ALGUNA TECLA
	BREQ		TECLA2A				; SI SE HA PULSADO SALTA A TECLA2A
	LDI			R16, 00				; SI ES ASI....
	MOV			TEMP_TEC, R16		; PONE EL CONTADOR DE RETARDO A CERO
TECLA2A:
;CPI	R17,0B11111110 ; VA A PROGRAMAR EL AJUSTE DE CORO Y REDOX
;BREQ TECLACL_RD
			; OPCION SALTAR PARA AJUSTE DE CLORO
	CPI			R17, 0B11111011		; TECLA 2
	BREQ		TECLA2U				; SALTA PARA AJUSTAR EL CLORO SI TIENE
			; OPCION SALIR DE LECTURA DE TECLADO 
	CPI			R17, 0B01111111		; TECLA 5
	BRNE		TECLA2B				; SI NO ES 80 SALTA A TECLA1D
	RJMP		TECLA2T				; TERMINA Y SALE PARA GRABAR
TECLA2B:	; OPCION AUMENTAR RD
	CPI			R17, 0B11101111		; TECLA 4 INCREMENTA EL VALOR
	BRNE		TECLA2C				; SI NO ESTA PULSADA SALTA PARA VERIFICAR OTRA TECLA
	LDI			R16, 00				; PONE EL RETARDO DEL TECLADO A 0
	MOV			TEMP_TEC, R16
	INC			R30					; INCREMENTA EL VALOR
	LDI			R22, 0				; CARGA EL RETARDO DE LECTURA DELTECLADO
	CPI			R30, RD_MAX			; VERIFICA SI ESTA EN EL VALOR MAXIMO
	BRBS		0, TECLA2C			; SI NO SUPERA EL VALOR MAXIMO SALTA
	LDI			R30, 170			; SI SUPERA EL MAXIMO LO PONE AL MAXIMO
TECLA2C:	; OPCION DISMINUIR RD
	CPI			R17, 0B11111101		; TECLA 1 PARA DISMINUIR
	BRNE		TECLA2D				; SI NO ESTA PULSADA SALTA
	LDI			R16, 00				; PONE EL RETARDO DEL TECLADO A 0
	MOV			TEMP_TEC, R16
	DEC			R30					; DISMINUYE EL VALOR
	LDI			R22, 0				; CARGA EL RETARDO DE LECTURA DEL TECLADO
	CPI			R30, RD_MIN			; COMPRUEBA SI SE ELCANZA EL VALOR MINIMO
	BRBC		0, TECLA2D			; SI NO SE ALCANZA SALTA
	LDI			R30, 130			; SI SE ALCANZA PONE EL VALOR MINIMO de redox
;********************** IR A PROGRAMACION DEL VALOR PARA EL APOYO DE REDOX******************
TECLA2D:
	CPI			R17, 0B11111110		; TECLA 0 PARA VA A PROGRAMAR LA DIFERENCIA PARA EL APOYO DE REDOX
	BRNE		TECLA2D_1			; SI NO ESTA PULSADA SALTA
	CALL		TECLACL_RD

TECLA2D_1:	; PONER EL VALOR EN PANTALLA
LDI			R22,00
LDI			R24,32
	STS			$097F, R24			; PARA VER LA FRECUENCIA EN PANTALLA
	STS			$0980, R24			; BORRA EL VALOR
	STS			$0981, R24	
RCALL		PRO_TECLA
TECLA2D_2:
CPI			R22,RETARDO3
BRLO		TECLA2D_2

	MOV			R24, R30
	RCALL		RADC5I    			; CONVERTIR UN NUMERO EN DIGITOS DATO EN R24
	STS			$097F, R1			; PARA VER LA FRECUENCIA EN PANTALLA
	STS			$0980, R2
	STS			$0981, R3		
	RCALL		PRO_TECLA
;	RCALL		LINEAP2
TECLA2E:
	CPI			R22,RETARDO2		; VALOR DEL TIEMPO DE RATARDO LECTURA DEL TECLADO
	BRLO		TECLA2E				; COMPRUEBA EL TIEMPO DE RETARDO 
	RJMP		TECLA2				; PARA PROGRAMAR EL REDOX REPITE CICLO	

TECLA2U:   ; GRABA EL VALOR DEL REDOX Y CARGA EL CLORO EN R30
	STS			RAMP_RD, R30		; ACTUALIZA EN RAM EL NUEVO VALOR PROGRAMADO DEL REDOX
	LDI			R17, RD_MEN
	MOV			R18, R30			; GRABA EL VALOR DEL REDOX EN EEPROM 242
;	RCALL		I2CE_2404			; ESCRIBE EL NUEVO VALOR EN LA EEPRON EXTERNA
	RCALL		EEPROM_ES	
	LDI			R16, 00				; PONE EL RETARDO DEL TECLADO A 0
	MOV			TEMP_TEC, R16
	RCALL		NO_TECLA
	RJMP		TECLA5V				; PROGRAMAR CICLOS






