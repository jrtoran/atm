
;  RUTINA CALIBRAR PARAMETROS PRODUCCION DE CLORO LIBRE


PRO9:	; PARA AJUSTAR LA SAL DEL AGUA
	SBRS			CONTROL,7			; SALTA LA PROXIMA INSTRUCION SI ES UNO, TIENE SONDA DE REDOX
	JMP				PRO6				; VA A CALIBRACION SAL
	CALL			CAL_TECLA			; PROGRAMA PANTALLA CALIBRACCION
	LDS				R30, RAMC_CL		; VALOR PARA EL CALIBRADO DE LA CONCENTRACION DE CLORO
	LDI				R22, 00
	CLR				R7					; PONE A CERO EL RETARDO SALIDA TECLADO
PRO9A:
	LDI				R22,00
	LDI				R18,32				; APAGA EL DIGITO SAL
	STS				$941,R18			; PONE EN PANTALLA EL VALOR CALIBRADO DE LA SAL UNIDADES
	STS				$942,R18
	STS				$943,R18			; PONE EN PANTALLA EL VALOR CALIBRADO DE LA SAL DECIMAS
;	STS				$92F,R18
	CALL			CAL_TECLA
PRO9B:			; TIEMPO DIGITO APAGADO
	CPI				R22,RETARDO3			; VALOR DEL TIEMPO DE RATARDO LECTURA DEL TECLADO
	BRLO			PRO9B				; COMPRUEBA EL TIEMPO DE RETARDO 
	CALL			LEDPANT
	WDR
	; VALOR DE MEDICION REDOX	
	LDI				R18,P_CL			; LINEA DE ENTRADA
	MOV				R26,R30				; NUMERO DE LECTURAS Ó CALIBRACION
	CALL			ADC_P
LSR			R24
LSR			R24			
SUBI		R24,15
	STS				RAM_CL, R24			; ALMACENA LA MEDICION EN LA MEMORIA RAM
	CALL			RADC
;	STS				$92D,R1
	STS				$941,R2
LDI	R16,46	; PONE UN PUNTO
STS $942,R16
	STS				$943,R3
	CALL			CAL_TECLA
PRO9C:				; DIGITO ENCENDIDO
	CPI				R22,RETARDO2				; VALOR DEL TIEMPO DE RATARDO LECTURA DEL TECLADO
	BRLO			PRO9C				; COMPRUEBA EL TIEMPO DE RETARDO 

	; VALOR DE MEDICION 	
	WDR
	LDI				R22,00				; reatardo lectura de las valores 
	CALL			LEC_TEC
	CPI				R17, 0B11111101		; TECLA - BAJA EL VALOR
	BREQ			BAJAR_CL
	CPI				R17, 0B11101111		; TECLA + INCREMENTA EL VALOR
	BREQ			SUBIR_CL
	CPI				R17, 0B01111111		; TECLA 7 SALIR VA A CALIBRACION REDOX
	BREQ			SALIR_CL1
	CPI				R17, 0B11111011		; TECLA FLECHA GRABA Y VA A CALIBRACION DE SAL
	BREQ			SALIR_CL
	MOV				R24, TEMP_TEC
	CPI				R24, 50				; PARA COMPARARLO CON EL RETARDO SIN PULSAR TECLA
	BRPL			SALIR_CL1			; Y SALIR DE PROGRAMACION DE PARAMETROS
	RJMP			PRO9A
BAJAR_CL:
	CLR				R7					; PONE A CERO EL RETARDO SALIDA TECLADO
	SUBI			R30,8
	LDI				R22,00
	CPI				R30,150				; VALOR MINIMO DE REDOX
	BRBC			0, BAJAR_CL1 
	LDI				R31,150
BAJAR_CL1:
	RJMP			PRO9A
SUBIR_CL:
	CLR				R7					; PONE A CERO EL RETARDO SALIDA TECLADO
	ADIW			R30,8
	LDI				R22,00
	CPI				R30,249				; REDOX MAXIMO
	BRBS			0, SUBIR_CL1		; SI MAYOR SALTA A SUBIR_PH1 Y PONE R31 CON EL VALOR MAZIMO
	LDI				R30,249
SUBIR_CL1:
	RJMP			PRO9A
SALIR_CL:  ; GRABA LOS NUEVOS VALORES Y VA A CALIBRAR CLORO
	STS				RAMC_CL, R30		; VALOR PARA EL CALIBRADO DE LA CONCENTRACION DE SAL
	LDI				R17, CLC_MEN		; POSICION DE MEMORIA A ESCRIBIR EN EEPROM $005
	MOV				R18, R30 
	CALL			EEPROM_ES			; GRABA EN EEPROM EL VALOR DE LA NUEVA CALIBRACCION
	MOV				R16, VAL_LED		; APAGA LUZ PANTALLA
	ANDI			R16, 0B10111111
	MOV				VAL_LED, R16
	CALL			LEDPANT				; ACTUALIZAR LOS LED DE LA PANTALLA	
	CALL			NO_TECLA			; PARA ESPERAR A QUE SE SUELTE LA TECLA SALIR
	JMP				PRO6				; VA A CLIBRACION DE SAL

SALIR_CL1:  ; GRABA LOS VALORES Y TERMINA
	STS				RAMC_CL, R30		; VALOR PARA EL CALIBRADO DE LA CONCENTRACION DE SAL
	LDI				R17, CLC_MEN		; POSICION DE MEMORIA A ESCRIBIR EN EEPROM $005
	MOV				R18, R30 
	CALL			EEPROM_ES			; GRABA EN EEPROM EL VALOR DE LA NUEVA CALIBRACCION
	MOV				R16, VAL_LED		;APAGA LUZ PANTALLA
	ANDI			R16, 0B10111111
	MOV				VAL_LED, R16
	CALL			LEDPANT				; ACTUALIZAR LOS LED DE LA PANTALLA	
	CALL 			NO_TECLA
	RET

