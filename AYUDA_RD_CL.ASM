; Para apoyar al redox y cloro
; EN R18 VALOR PROGRAMADO
; EN R19 VALOR REAL LEIDO
; REDOX PROGRAMABLE HASTA MENOS 80mV PARA LA BOMBA A LA MITAD DEL VALOR PROGRAMADO MAS 5 MILIVOLTIOS
; CLORO ENCIENDE LA BOMBA HASTA MENOS 8 DECIMAS PROGRAMABLES, APAGA A 0,8 DE CLORO FIJO
.equ  S_RD_CL	= 1			; salida para el apoyo de redox y cloro 

AYUDA_RD:
	PUSH			R18
	SBRS			CONTROL_1,7			; SALTA LA PROXIMA INSTRUCION SI ES UNO,NO SE A PRODUCIDO INVERSION
	RJMP			AYUDA_RD_A2			; NO TIENE EN CUENTA EL PRIMER CICLO FUNCIONA SI O SI
AYUDA_RD_A:
	LDS				R24,RAM_RD_CL		; POSICION 216 EN RAM
	LSL				R24					; MULTIPLICA POR 2
	SUB				R18,R24				; DIFERENCIA PARA EL APOYO DE LA BOMBA CADO UNIDAD SON 5 mV
	CP				R19,R18				; SI EL REDOX MEDIDO ES MENOR QUE EL PROGRAMADO
	BRLO			AYUDA_RD_A1			; SALTA A PRO5A (OP1 > OP2 SALTA) ENCIENDE LA BOMBA
; SOLO APAGA LA BOMBA CUANDO ALCANZA LA MITAD MAS 1 DEL VALOR PROGRAMADO
	LSR				R24					; DIVIDE POR 2 
	INC				R24
	INC				R24
	ADD				R18,R24
	CP				R18,R19				; PARA PARAR LA BOMBA CUANDO LLEGE AL VALOR DE RD PROGRAMAD0
	BRLT			AYUDA_RD_A2			; SALTA A AYUDA_RD_A1 SI OP1>OP2
	POP				R18
	RET
AYUDA_RD_A1:
	SBI				PORTB,S_RD_CL		; ENCIENDE LA BOMBA DE APOYO
	LDI				R18,1
	STS				APOYO_CL,R18		; PONE LA SE헤L EN RS232 UN UNO
	POP				R18
	RET
AYUDA_RD_A2:
	CBI				PORTB,S_RD_CL		; DESCONECTA LA BOMBA DE APOYO 
	LDI				R18,0
	STS				APOYO_CL,R18		; PONE LA SE헤L EN RS232 UN CERO
	POP				R18
	RET
; RUTINA APOYO CLORO LIBRE CORTA LA DOSIFICACION EN 0,8 ************************************************

AYUDA_CL:
	PUSH			R18
	SBRC			CONTROL_1,7			; SALTA LA PROXIMA INSTRUCION SI ES CERO,NO SE A PRODUCIDO INVERSION
	RJMP			AYUDA_CL_A2			; SI NO ESTA VAA APAGAR LA BOMBA
AYUDA_CL_A:
	LDS				R24,RAM_RD_CL		; POSICION EN RAM 216
;CALL PRU2
	SUB				R18,R24				; DIFERENCIA PARA EL APOYO DE LA BOMBA CADO UNIDAD SON 5 mV
	INC				R18
	CP				R19,R18				; SI EL REDOX MEDIDO ES MENOR QUE EL PROGRAMADO
	BRLO			AYUDA_CL_A1			; SALTA A PRO5A (OP1 > OP2 SALTA)
;	LSR				R24
;	INC				R24
;	ADD				R18,R24
	LDI				R18,7				; PARA PARAR LA BOMBA A 0,8 PPM DE CLORO FIJO
	CP				R18,R19
	BRLT			AYUDA_CL_A2
	POP				R18
	RET
AYUDA_CL_A1:
	SBI				PORTB,S_RD_CL		; ENCIENDE APOYO LA BOMBA
	LDI				R18,1
	STS				APOYO_CL,R18		; PONE LA SE헤L EN RS232 UN UNO
	POP				R18
	RET
AYUDA_CL_A2:
	CBI				PORTB,S_RD_CL		; DESCONECTA EL  APOYO LA BOMBA 1
	LDI				R18,0
	STS				APOYO_CL,R18		; PONE LA SE헤L EN RS232 A CERO
	POP				R18
	RET

PRU2:
PUSH R24
PUSH R18
PUSH R19
CALL RADC
STS $230,R2
STS $231,R3

MOV R24,R18
CALL RADC
;STS				$250,R1
STS				$250,R2
STS				$251,R3	
MOV R24,R19
CALL RADC
STS				$252,R1
STS				$253,R2
STS				$254,R3	
POP R19
POP R18
POP R24
RET

