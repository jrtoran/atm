; DIGITOS DE CONTROL
; EN R24 EL VALOR EN DECIMAL
; DIGITO CERO: 	A CERO PRESENTA DIGITOS 2 Y 4
;				A 1 PRESENTO LOS 4 DIGITOS

; DIGITOS 1 Y 2 PONEN INTERMITENCIA EN 1 Y 3 Ó 2 Y 4

; DIGITO 3 ENCIENDO TODO

;  RUTINA PARA EL CONTROL DEL PERIFERICO SAA1064
;EN R24 DOS PRIMEROS DIGITOS EN R25 DOS ULTIMOS

SAA1064:

	WDR
	PUSH		R21
	PUSH		R25
	RCALL		RABCD			; CONVIERTE R24 R25 EN LOS VALORES DE R1-2-3-4 PARA ENVIAR AL CONVERTIDOR
								; TIENEN QUE SER DE DOS DIGITOS
	LDI   		R25, RI2C		; ESPERA RETARDO
	RCALL 		RETARDOA
	LDI			R21, 0B01110000	; BIT LOCALIZACION PERIFERICO ($70) Y DIRECION, LECTURA O ESCRITURA
	RCALL 		I2C				; ENVIAR LA SEÑAL DE START E IDENTIFICACION PERIFERICO EN R21
	RCALL		ACK
	LDI   		R25, RI2C		; ESPERA RETARDO
	RCALL 		RETARDOA
	LDI   		R21, $000		; ENVIAR DIRECION A ESCRIBIR
	RCALL 		ENV_BYT
	RCALL		ACK
	LDI   		R25, RI2C		; ESPERA RETARDO
	RCALL 		RETARDOA
	LDI   		R21, 0B00010001	; ENVIAR VALOR A ESCRIBIR
	RCALL 		ENV_BYT
	RCALL		ACK
	WDR
	
	MOV   		R21, R4			; ENVIAR VALOR A ESCRIBIR
	RCALL		ABCD
	RCALL 		ENV_BYT
	RCALL		ACK

	MOV   		R21, R3			; ENVIAR VALOR A ESCRIBIR
	RCALL		ABCD
	RCALL 		ENV_BYT
	RCALL		ACK

	MOV   		R21, R2			; ENVIAR VALOR A ESCRIBIR
	RCALL		ABCD
	RCALL 		ENV_BYT
	RCALL		ACK

	MOV   		R21, R1			; ENVIAR VALOR A ESCRIBIR
	RCALL		ABCD
	RCALL 		ENV_BYT
	RCALL		ACK
	RCALL 		I2CS			; ENVIAR SEÑAL DE STOP
	POP			R25
	POP			R21
	RET

ABCD:   ;CALCULO DE LOS DIGITOS A ENCENDER
	CPI			R21, 0
	BRBC		1, ABCD1
	LDI			R21, 0B00111111	; EN HEXADECIMAL 3F
	RET
ABCD1:
	CPI			R21, 1
	BRBC		1, ABCD2
	LDI			R21, 0B00000110	; EN HEXADECIMAL 6
	RET
ABCD2:
	CPI			R21, 2
	BRBC		1, ABCD3
	LDI			R21, 0B01011011	; EN HEXADECIMAL 58
	RET
ABCD3:
	CPI			R21, 3
	BRBC		1, ABCD4
	LDI			R21, 0B01001111	; EN HEXADECIMAL 4F
	RET
ABCD4:
	CPI			R21, 4
	BRBC		1, ABCD5
	LDI			R21, 0B01100110	; EN HEXADECIMAL 66
	RET
ABCD5:
	CPI			R21, 5
	BRBC		1, ABCD6
	LDI			R21, 0B01101101	; EN HEXADECIMAL 6D 
	RET
ABCD6:
	CPI			R21, 6
	BRBC		1, ABCD7
	LDI			R21, 0B01111101	; EN HEXADECIMAL 7D 
	RET
ABCD7:
	CPI			R21, 7
	BRBC		1, ABCD8
	LDI			R21, 0B00000111	; EN HEXADECIMAL 7
	RET
ABCD8:
	CPI			R21, 8
	BRBC		1, ABCD9
	LDI			R21, 0B01111111	; EN HEXADECIMAL 7F
	RET
ABCD9:
	LDI			R21, 0B01101111	; EN HEXADECIMAL 6F

	RET

RABCD:
	CLR			R1
	CLR			R2
	CLR			R3
	CLR			R4
	CPI			R24, 10
	BRLO		RABCD2
	INC			R1
RABCD1:
	SUBI		R24, 10	
	CPI			R24, 10
	BRLO		RABCD2
	INC			R1
	RJMP		RABCD1
RABCD2:
	MOV			R2, R24

	CPI			R25, 10
	BRLO		RABCD4
	INC			R3
RABCD3:
	SUBI		R25, 10	
	CPI			R25, 10
	BRLO		RABCD4
	INC			R3
	RJMP		RABCD3
RABCD4:
	MOV			R4, R25

	RET
