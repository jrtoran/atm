

; RUTINA PARA RS232 PROGRAMAR AJUSTAR Y CALIBRAR PARAMETROS
; LEE Y ALMACENA EN RG_232 LOS DATOS LEIDOS DE LA INTERRUPCION
; EN FUNCION DEL VALOR LEIDO AJUSTA LA PRODUCCION PH RD ETC Y LO ALMACENA DE NUEVO


; RUTINA PARA RECIBIR DATOS DE LA UART1 **********RECIBE 3 DATOS Y LO GRABA EN EEPRON POSICION 200- C8**** POSICION Y VALOR

;	RUTINA PARA GUARDAR LOS DATOS RECIBIDOS EN RAM








N_PRO_PAR:
; COMPRUEBA EL CODIGO A MEDIFICAR QUE ES EL SEGUNDO ENVIADO RG_232+1
		PUSH		R16
		PUSH		R17
		PUSH		R18
		PUSH		R19
		PUSH		R24
		IN			R16,SREG			; SALVA EL REGISTRO DE ESTADO
		PUSH		R16

LDI	R18,0xFF
STS	RG_232,R18
		LDS			R18,RG_232+1		; LEE DE LA RAM LA POSICION A PROGRAMAR O CALIBRAR
		CPI			R18,21				; 15 EN HEX
		BREQ		RS_PRO				; PROGRAMAR LA PRODUCION
		CPI			R18,22
		BREQ		RS_PH				; PROGRAMAR EL PH 
		CPI			R18,25
		BREQ		RS_RD_SALTO				; PROGRAMAR EL REDOX
		CPI			R18,27
		BREQ		RS_CL_SALTO			; PROGRAMAR EL CLORO
		RJMP		RS_SALTO
RS_CL_SALTO:
		RJMP		RS_CL
RS_RD_SALTO:
		RJMP		RS_RD

; PONE LOS VALORES RECIEN PROGRAMADOS EN RAM Y EPROM

RS_PRO:	; RECIBO UN 21		PROGRAMAR LA PRODUCCION POSICION EN RAN 0x956 *****************************

	LDS			R17,RG_232+2
	LDS			R18,RAMP_PRO
	CPI			R17,1
	BREQ		RS_PRO_B			; SI ES IGUAL VA A BAJAR PRODUCCION
	INC			R18
	INC			R18
	CPI			R18,100
	BRLT		RS_PRO_C
	LDI			R18,100
	RJMP		RS_PRO_C
RS_PRO_B:
	DEC			R18
	DEC			R18
	CPI			R18,5
	BRBC		0,RS_PRO_C
	LDI			R18,5
RS_PRO_C:
	STS			RAMP_PRO,R18		; GRAMA EN RAN EL VALOR DE LA PRODUCCION
	LDI			R17,PRO_MEN
	CALL		EEPROM_ES			; GRABA EN EEPROM EL NUEVO VALOR DE LA PRODUCCION
	MOV			R24,R18
	CALL		RADC   				; CONVERTIR UN NUMERO EN DIGITOS DATO EN R24
	STS			$0956, R1			
	STS			$0957, R2			; PONE EL RESULTADO EN PANTALLA DECENAS DE PRODUCCION
	STS			$0958, R3			; PONE EL RESULTADO EN PANTALLA UNIDADES DE PRODUCCION
	RJMP		RS_FIN


RS_PH:	; RECIBO UN 22			 PROGRAMAR EL PHP PROGRAMADO POSICCION 0x96B ****************************
	LDS			R17,RG_232+2
	LDS			R18,RAMP_PH
	CPI			R17,1
	BREQ		RS_PH_B
	INC			R18
	CPI			R18,80
	BRLT		RS_PH_C
	LDI			R18,80
	RJMP		RS_PH_C
RS_PH_B:
	DEC			R18
	CPI			R18,65
	BRBC		0,RS_PH_C
	LDI			R18,65
RS_PH_C:
	STS			RAMP_PH,R18			; GRAMA EN RAM DEL NUEVO PH
	LDI			R17,PH_MEN
	CALL		EEPROM_ES			; GRABA EN EEPROM EL NUEVO VALOR DEL PH
	MOV			R24, R18			; PONE EL VALOR EN R24 PARA CONVERTIRLO EN DECIMAL
	CALL		RADC   				; CONVERTIR UN NUMERO EN DIGITOS DATO EN R24
	STS			$96B, R2			; PONE EL RESULTADO EN PANTALLA DECENAS DE PH
	LDI			R16, 46				; pone un punto
	STS			$096C, R16
	STS			$096D, R3			; PONE EL RESULTADO EN PANTALLA UNIDADES DE PH
	RJMP		RS_FIN

RS_RD:	; RECIBO UN 25			PROGRAMAR EL REDOX PROGRAMADO POSICION  POSICION 0x97F******************************
	LDS			R17,RG_232+2
	LDS			R18,RAMP_RD
	CPI			R17,1
	BREQ		RS_RD_B
	INC			R18
	RJMP		RS_RD_C
RS_RD_B:
	DEC			R18
RS_RD_C:
	STS			RAMP_RD,R18			; GRABA EN RAM DEL NUEVO REDOX
	LDI			R17,RD_MEN
	CALL		EEPROM_ES			; GRABA EN EEPROM EL NUEVO VALOR DE REDOX
	MOV			R24, R18
	CALL		RADC5I    			; CONVERTIR UN NUMERO EN DIGITOS DATO EN R24
	STS			$097F, R1			; PARA VER LA FRECUENCIA EN PANTALLA
	STS			$0980, R2
	STS			$0981, R3
	RJMP		RS_FIN
;	RET

RS_CL:	; RECIBO UN 27  PASICION EN RAM 0x992 CLORO PROGRAMADO ***************************************
	LDS			R17,RG_232+2
	LDS			R18,RAMP_CL
	CPI			R17,1
	BREQ		RS_CL_B
	INC			R18
	CPI			R18,20
	BRBS		0, RS_CL_C			; SI NO SUPERA EL VALOR MAXIMO SALTA
	LDI			R18,20
	RJMP		RS_CL_C
RS_CL_B:
	DEC			R18
	CPI			R18,6
	BRBC		0,RS_CL_C
	LDI			R18,6
RS_CL_C:
	STS			RAMP_CL,R18			; GRABA EN RAM DEL NUEVO DEEL CLORO PROGRAMADO
	LDI			R17,CL_MEN
	CALL		EEPROM_ES			; GRABA EL NUEVO VALOR DEL CLORO PROGRAMADO EN EEPROM
	MOV			R24, R18		; PONE EL VALOR EN R24 PARA CONVERTIRLO EN DECIMAL
	CALL		RADC   			; CONVERTIR UN NUMERO EN DIGITOS DATO EN R24
	STS			$992, R2		; PONE EL RESULTADO EN PANTALLA DECENAS DE CL
	LDI			R16, 46
	STS			$993, R16
	STS			$994, R3		; PONE EL RESULTADO EN PANTALLA UNIDADES DE CL
	RJMP		RS_FIN
;	RET

RS_CI:	; RECIBO UN 29				; PROGRAMAR CICLOS  0x9AA POSICION EN RAM   *****************
	LDS			R17,RG_232+2
	LDS			R18,RAM_CICLOS
	CPI			R17,1
	BREQ		RS_CI_B
	INC			R18
	CPI			R18,4
	BRLT		RS_CI_C
	LDI			R18,4
	RJMP		RS_CI_C
RS_CI_B:
	DEC			R18
	CPI			R18,1
	BRBC		0,RS_CI_C
	LDI			R18,1
RS_CI_C:
	STS			RAM_CICLOS,R18			; GRABA EN RAM LOS NUEVOS CICLOS
	LDI			R17,CICLOS_MINUTO
	CALL		EEPROM_ES	
	MOV			R24, R18			; PONE EL VALOR EN R24 PARA CONVERTIRLO EN DECIMAL
	CALL		RADC   				; CONVERTIR UN NUMERO EN DIGITOS DATO EN R24
	STS			$09AA, R3			; PONE EL RESULTADO EN PANTALLA UNIDADES DE CICLOS
	RJMP		RS_FIN
;	RET

; OPCION PARA CALIBRAR SAL PH RD CL
; PRIMERO ENVIA EL CODIGO DE ORDEN Y LUEGO EL VALOR


RSC_SAL:			; CALIBRAR LA SAL + -  CODIGO 24
	LDS			R30, RAMC_SAL		; VALOR PARA EL CALIBRADO DE LA CONCENTRACION DE SAL
;SUBIR SAL
	LDS			R17,RG_232+2
	CPI			R17,1				; CODIGO ASCI DEL MENOS
	BREQ		REC_SAL_B			; SI ES IGUAL VA A REC_SAL_B
	INC			R30
	INC			R30
	INC			R30
	CPI			R30, 180			; VALOR MAXIMO DE NUMERO DE VECES DE LECTURA.
	BRLT		REC_SAL_A		; SI MENOR SALTA
	LDI			R30,180				; COMO ES MAYOR PONE EL MAXIMO
	RJMP		REC_SAL_A
REC_SAL_B:						; BAJAR LA CONCENTRACION DE SAL
	DEC			R30
	DEC			R30
	DEC			R30
	CPI			R30, 50				; COMPRARA SI ES MENOR
	BRBC		0, REC_SAL_A 		; SI ES MAYOR SALTA
	LDI			R30, 50				; PONE EL VALOR MINIMO
REC_SAL_A:
	LDI			R18, P_SAL			; LINEA DE ENTRADA EN EL CONVERTIDOR PCF8591
	MOV			R26, R30			; NUMERO DE LECTURAS Ó CALIBRACION
	CALL		ADC_P
;	LDS			R18,RAM_MED_INI_SAL	; CARGA EL ERROR INICIAL DEL TLC26 EN R18
;	SUB			R24,R18				; RESTA EL ERROR INICIAL DE LA MEDICION
	STS			RAM_SAL_C, R24		; ALMACENA LA MEDICION EN LA MEMORIA RAM VALOR A ENVIAR POR RS ****+
	STS			RAMC_SAL, R30		; VALOR PARA EL CALIBRADO DE LA CONCENTRACION DE SAL
	LDI			R17, SAC_MEN		; POSICION DE MEMORIA A ESCRIBIR EN EEPROM $005
	MOV			R18, R30 
	CALL		EEPROM_ES			; GRABA EN EEPROM EL VALOR DE LA NUEVA CALIBRACCION
	CALL		RADC   				; CONVERTIR UN NUMERO EN DIGITOS DATO EN R24
	STS			$0905, R2			
	STS			$0907, R3			; PONE EL RESULTADO EN PANTALLA DECENAS DE PRODUCCION
	RJMP		RS_FIN
;	RET

RS_SALTO:		; VIENE DE LA LINEA 85

	CPI			R18,29
	BREQ		RS_CI_SALTO				; PROGRAMAR LOS CICLOS
	CPI			R18,24
	BREQ		RSC_SAL				; CALIBRAR LA CONCENTRACCION DE SAL
	CPI			R18,23
	BREQ		RSC_PH				; CALIBRAR EL PH DEL AGUA
	CPI			R18,26
	BREQ		RSC_RD				; CALIBRAR EL REDOX DEL AGUA
	RJMP		RS_SALTO2
RS_CI_SALTO:
	RJMP		RS_CI
			; REPITE VA A LEER UN NUEVO VALOR
RSC_PH:		; CALIBRAR EL PH RECIBE DE LA NEXTION UN 23  ********************************* COMPLETADO *******************
	LDS			R30, RAMC_PH		; VALOR PARA EL CALIBRADO DEL PH
	LDS			R17,RG_232+2		; LEE LA POSICION PARA INCREMENTAR O BAJAR
	CPI			R17,1				; CODIGO ASCI DEL MENOS
	BREQ		RSC_PH_B			; ES MENOS VA A BAJAR
	INC			R30					; INCREMENTA EL PH
	CPI			R30,22				; LO COMPARA CON EL MAXIMO
	BRLT		RSC_PH_A			; SI ES MAS BAJO VA A RSC_PH_A
	LDI			R30,22				; EN CASO DE SER MAS ALTO PONE EL MAXIMO		
	RJMP		RSC_PH_A
RSC_PH_B:
	DEC			R30					; BAJA EL PH
	CPI			R30,2				; LO COMPARA CON EL VALOR MINIMO
	BRBC		0,RSC_PH_A			; SI ES MAS ALTO VA A RCS_PH_A
	LDI			R30,2				; SI ES MAS BAJO PONE EL MINIMO
RSC_PH_A:
	LDI			R18, P_PH			; LINEA DE ENTRADA EN EL CONVERTIDOR PCF8591
	LDI			R26, 231			; NUMERO DE LECTURAS Ó CALIBRACION
	CALL		ADC_P				; DEVUELVE EL RESULTADO EN R24
	LDI			R16, 216			; RESTA 10 PARA LUEGO SUMARLE LA CALIBRACION ENTRE 0 Y 20
	SUB			R16, R24			; Y RESTANDOLO DEL LEIDO			
	MOV			R19, R30			; LEE EL VALOR DE CALIBRACION que suele ser 10
	ADD			R16, R19			; SE LA SUMA AL LEIDO
	MOV			R24,R16
	STS			RAM_PH, R24			; ALMACENA LA MEDICION EN LA MEMORIA RAM
	CALL		RADC   				; CONVERTIR UN NUMERO EN DIGITOS DATO EN R24
	STS			$046D, R2			; PONE EL RESULTADO EN PANTALLA DECENAS DE PH
	LDI			R16, 46				; pone un punto
	STS			$046E, R16
	STS			$046F, R3			; PONE EL RESULTADO EN PANTALLA UNIDADES DE PH
	STS			RAMC_PH, R30		; VALOR PARA EL CALIBRADO DEL PH
	LDI			R17, PHC_MEN		; POSICION DE MEMORIA A ESCRIBIR EN EEPROM $005
	MOV			R18, R30 
	CALL		EEPROM_ES			; GRABA EN EEPROM EL VALOR DE LA NUEVA CALIBRACCION
	RJMP		RS_FIN


RSC_RD:
	LDS			R30,RAMC_RD			; VALOR PARA EL CALIBRADO DE LA CONCENTRACION DE SAL
	LDS			R17,RG_232+2		; LEE LA POSICION PARA INCREMENTAR O BAJAR
	CPI			R17,1				; CODIGO ASCI DEL MENOS
	BREQ		RSC_RD_B			; ES MENOS VA A BAJAR
	INC			R30					; INCREMENTA EL PH
	INC			R30
	CPI			R30,254				; LO COMPARA CON EL MAXIMO
	BRBS		0,RSC_RD_A			; SI ES MAS BAJO VA A RSC_PH_A
	LDI			R30,254				; EN CASO DE SER MAS ALTO PONE EL MAXIMO		
	RJMP		RSC_RD_A
RSC_RD_B:
	DEC			R30
	DEC			R30					; BAJA EL PH
	CPI			R30,200				; LO COMPARA CON EL VALOR MINIMO
	BRBC		0,RSC_RD_A			; SI ES MAS ALTO VA A RCS_PH_A
	LDI			R30,200		
RSC_RD_A:
	LDI			R18,P_RD			; LINEA DE ENTRADA
	MOV			R26,R30				; NUMERO DE LECTURAS Ó CALIBRACION
	CALL		ADC_P
	SUBI		R24,46
	STS			RAM_RD,R24			; ALMACENA LA MEDICION EN LA MEMORIA RAM
	CALL		RADC5I
	STS			$9BB,R1
	STS			$9BC,R2
	STS			$9BD,R3
	STS			RAMC_RD,R30			; VALOR PARA EL CALIBRADO DE LA CONCENTRACION DE SAL
	LDI			R17,RDC_MEN			; POSICION DE MEMORIA A ESCRIBIR EN EEPROM $005
	MOV			R18,R30 
	CALL		EEPROM_ES			; GRABA EN EEPROM EL VALOR DE LA NUEVA CALIBRACCION
	RJMP		RS_FIN

RS_SALTO2:

	CPI			R18,30
	BREQ		RSC_CL				; CALIBRAR EL CLORO DEL AGUA
	CPI			R18,0+48
;	BREQ		RS_RET1				; PARA FINALIZAR SI ME ENVIA UN CERO
	RJMP		RS_FIN	
;	RET

RSC_CL:
	LDS			R30, RAMC_CL		; VALOR PARA EL CALIBRADO DE LA CONCENTRACION DE CLORO
	LDS			R17,RG_232+2		; LEE LA POSICION PARA INCREMENTAR O BAJAR
	CPI			R17,1				; CODIGO ASCI DEL MENOS
	BREQ		RSC_CL_B			; ES MENOS VA A BAJAR
	ADIW		R30,8				; INCREMENTA EL VALOR DEL CLORO LEIDO
	CPI			R30,249				; LO COMPARA CON EL MAXIMO
	BRBS		0,RSC_CL_A			; SI ES MAS BAJO VA A RSC_PH_A
	LDI			R30,249				; EN CASO DE SER MAS ALTO PONE EL MAXIMO		
	RJMP		RSC_CL_A
RSC_CL_B:
	SUBI		R30,8				; BAJA EL CLORO LEIDO
	CPI			R30,150				; LO COMPARA CON EL VALOR MINIMO
	BRBC		0,RSC_CL_A			; SI ES MAS ALTO VA A RSC_CL
	LDI			R30,150		
RSC_CL_A:
	LDI			R18,P_CL			; LINEA DE ENTRADA
	MOV			R26,R30				; NUMERO DE LECTURAS Ó CALIBRACION
	CALL		ADC_P
	LSR			R24
	LSR			R24			
	SUBI		R24,15
	STS			RAM_CL, R24			; ALMACENA LA MEDICION EN LA MEMORIA RAM
	CALL		RADC   				; CONVERTIR UN NUMERO EN DIGITOS DATO EN R24
	STS			$09CE, R2			; PONE EL RESULTADO EN PANTALLA DECENAS DE CL
	LDI			R16, 46				; pone un punto
	STS			$09CF, R16
	STS			$09D0, R3			; PONE EL RESULTADO EN PANTALLA UNIDADES DE CL
	STS			RAMC_CL, R30		; VALOR PARA EL CALIBRADO PARA EL CLORO
	LDI			R17, CLC_MEN		; POSICION DE MEMORIA A ESCRIBIR EN EEPROM $005
	MOV			R18, R30 
	CALL		EEPROM_ES			; GRABA EN EEPROM EL VALOR DE LA NUEVA CALIBRACCION
	RJMP		RS_FIN
;	RET



;	RJMP			RS_RET1
;	RJMP			BIT_REC_11
; ENVIO DEL RESULTADO POR RS 232 VALOR A ENVIAR EN R24

;RS_ENVIO:							; ENVIA EL NUMERO DE ORDEN Y EL NUEVO VALOR
	STS 		UDR1,R24		; pone el valor de dato en el registro de transmision
RS_ENVIO_A:
	LDS			R16,UCSR1A
	SBRS		R16,UDRE1		; VERIFICA EL ENVIO DE LOS BITS BUFER VACIO
	RJMP		RS_ENVIO_A		; EN CUYO CASO SALTA ESTA INSTRUCION
	RET			
RS_FIN:
								; TERMINA Y RESTAURA LOS REGISTROS TERMINA CON RETI
	POP			R16
	OUT			SREG,R16
	POP			R24
	POP			R19
	POP			R18
	POP			R17
	POP			R16
	LDI			R25, 00
	STS			UCSR1A, R25
CALL		CADENA_UART				;  =================  PARA VER SI SE ACELERA EL ENVIO A LA APP =================================
	RET


;  ***********************************************************************************************


DATO_ASCI:				;**************** PONE EN MEMORIA RAM LOS VALORES DE LA RS232 ??????????SOLO VERIFICACION


	LDS				R24,RG_232
	CALL			RADC				; PRESENTA EN LINEA 3 LA MEDICION DE SAL REAL
	STS				$AC4, R1			; DECENAS
	STS				$AC5, R2			; UNIDADES
	STS				$AC6, R3			; DECIMAS	

	LDS				R24,RG_232+1
	CALL			RADC				; PRESENTA EN LINEA 3 LA MEDICION DE SAL REAL
	STS				$AC8, R1			; DECENAS
	STS				$AC9, R2			; UNIDADES
	STS				$ACA, R3			; DECIMAS	

	LDS				R24,RG_232+2
	CALL			RADC				; PRESENTA EN LINEA 3 LA MEDICION DE SAL REAL
	STS				$ACC, R1			; DECENAS
	STS				$ACD, R2			; UNIDADES
	STS				$ACE, R3			; DECIMAS	

	LDI				R19,32				; LIMPIA POSICIONES VACIAS PONE UN ESPACIO
	STS				$AC7,R19
	STS				$ACB,R19
	STS				$ACC,R19
	STS				$ACF,R19
	LDI				R16,128				; ESCRIBIR LINEA 1 DATOS ENVIADOS POR RS-232
	CALL			ENVINT				; En subrrutina Env_doi Envia instrucion para escribir en linea 1
	LDI				YH,HIGH(LIN1P)		; POSICION BIT ALTO DEL TEXTO A ENVIAR ram en 070
	LDI				YL,LOW (LIN1P)		; POSICION BIT BAJO DEL TEXTO A ENVIAR
	LDI				R17,20				; NUMERO DE DIGITOS A ENVIAR A PANTALLA
	CALL			ENVIARTEXTO			; RUTINA EN ESTE FICHERO PRECISA SUBRRUTINA ENV_DOI

	RET
