; RUTINA DEL TECLADO PARA AJUSTE DEL PORCENTAJE DE PRODUCION
; TECLA 0 PROGRAMAR
; TECLA 1 MENOS
; TECLA 2 FLECHA
; TECLA 3 CALIBRAR
; TECLA 4 MAS
; TECLA 5 
; TECLA 6 NIVEL ACIDO
; TECLA 7 SALIR


TECLA4T:	; GRABA EL NUEVO PORCENTAJE DE PRODUCCION Y TERMINA
	STS			RAMP_PRO, R30		; ACTUALIZA EN RAM EL NUEVO VALOR PROGRAMADO DE LA PRODUCION
;	LDI			R16, 00
	LDI			R17, pro_men
	MOV			R18, R30			; GRABA EL VALOR DEL REDOX EN EEPROM POSICION 241
;	RCALL		I2CE_2404			; ESCRIBE EL NUEVO VALOR EN LA EEPRON EXTERNA
	RCALL		EEPROM_ES
	MOV			R16, VAL_LED
	ANDI		R16, 0B10111111
	MOV			VAL_LED, R16
	RCALL		LEDPANT				; ACTUALIZAR LOS LED DE LA PANTALLA	
	RCALL		NO_TECLA
;CALL		P_NEXTION_PAGE
	RET

TECLA4U:  ; GRABA EL PORCENTAJE Y CARGA LOS CICLOS PARA LA INVERSION
	STS			RAMP_PRO, R30		; ACTUALIZA EN RAM EL NUEVO VALOR PROGRAMADO DE LA PRODUCION
;	LDI			R16, 00
	LDI			R17, pro_men
	MOV			R18, R30			; GRABA EL VALOR DEL REDOX EN EEPROM POSICION 241
;	RCALL		I2CE_2404			; ESCRIBE EL NUEVO VALOR EN LA EEPRON EXTERNA
	RCALL		EEPROM_ES

	LDS			R30, RAM_CICLOS
	LDI			R16, 00				; PONE EL RETARDO DEL TECLADO A 0
	MOV			TEMP_TEC, R16
	RCALL		NO_TECLA
	RJMP		TECLA				; VA A RUTINA PROGRAMACION DE PH
AJUSTE_PRE:
	CALL		AJUSTE_PRESENTACION
	RET
TECLA4V:
	CPI			r22, RETARDO1
	BRLO		TECLA4V	
	LDS			R30, RAMP_PRO		; LEE EL VALOR PROGRAMADO EN LA RAM
	LDI			R22,00

TECLA4:								; AJUSTAR EL VALOR DEL TANTO POR CIENTO DE LA PRODUCION VALOR EN R30
	MOV			R16, VAL_LED
	ORI			R16, 0B01000000		; ENCIENDE LA LUZ DE LA PANTALLA
	MOV			VAL_LED, R16
	RCALL		LEDPANT		


	WDR
	MOV			R24, TEMP_TEC
	CPI			R24, retardo_programacion	; PARA COMPARARLO CON EL RETARDO 20 SEGUNDOS SIN PULSAR TECLA
	BRPL		TECLA4T				; Y SALIR DE PROGRAMACION DE PARAMETROS					
	CALL		LEC_TEC				; RUTINA LECTURA DE TECLADO
	CPI			R17, 0B11111111		; COMPRUEBA SI SE A PULSADO ALGUNA TECLA
	BREQ		TECLA4A				; SI SE HA PULSADO SALTA A TECLA4A
	LDI			R16, 00				; SI ES ASI....
	MOV			TEMP_TEC, R16		; PONE EL CONTADOR DE RETARDO A CERO
TECLA4A:

	CPI			R17, 0B01110010
	BREQ		AJUSTE_PRE			; AJUSTE PRESENTACION	
			; OPCION SALTAR PARA AJUSTE DE PH
	CPI			R17, 0B11111011		; TECLA 2
	BREQ		TECLA4U				; SALTA PARA AJUSTAR EL PH
			; OPCION SALIR DE LECTURA DE TECLADO 
	CPI			R17, 0B01111111		; TECLA 5 
	BRNE		TECLA4B				; SI NO ES 80 SALTA A TECLA1D
	RJMP		TECLA4T				; TERMINA Y SALE PARA GRABAR
TECLA4B:	; OPCION AUMENTAR
	CPI			R17, 0B11101111		; TECLA 2 INCREMENTA EL VALOR
	BRNE		TECLA4C				; SI NO ESTA PULSADA SALTA PARA VERIFICAR OTRA TECLA
	LDI			R16, 00				; PONE EL RETARDO DEL TECLADO A 0
	MOV			TEMP_TEC, R16
	INC			R30					; INCREMENTA EL VALOR
	LDI			R22, 0				; CARGA EL RETARDO DE LECTURA DELTECLADO
	CPI			R30, PRO_MAX		; VERIFICA SI ESTA EN EL VALOR MAXIMO
	BRLT		TECLA4C				; SI NO SUPERA EL VALOR MAXIMO SALTA
	LDI			R30, PRO_MAX		; SI SUPERA EL MAXIMO LO PONE AL MAXIMO
TECLA4C:	; OPCION DISMINUIR PRODUCION
	CPI			R17, 0B11111101		; TECLA 2 PARA DISMINUIR
	BRNE		TECLA4C1			; SI NO ESTA PULSADA SALTA
	LDI			R16, 00				; PONE EL RETARDO DEL TECLADO A 0
	MOV			TEMP_TEC, R16
	DEC			R30					; DISMINUYE EL VALOR
	LDI			R22, 0				; CARGA EL RETARDO DE LECTURA DEL TECLADO
	CPI			R30, PRO_MIN		; COMPRUEBA SI SE ELCANZA EL VALOR MINIMO
	BRBC 		0, TECLA4D			; SI NO SE ALCANZA SALTA
	LDI			R30, PRO_MIN		; SI SE ALCANZA PONE EL VALOR MINIMO
TECLA4C1:	; OPCION PRODUCION MANUAL ANULA REDOX Y CLORO
	CPI			R17, 0B11110101		; TECLA CALIBRAR Y MENOS
	BRNE		TECLA4C2			; SI NO ESTA PULSADA SALTA
	LDI			R17, PA_PM
	LDI			R18, 0
	CALL		EEPROM_ES
	CBI			PORTB, S_RD_CL		; DESCONECTA EL  APOYO LA BOMBA DE REDOX Y CLORO
	CLT								; PONE A 1 EL REGISTRO T DE SREG
	BLD			CONTROL_1,2			; LINEA DE CONTROL 
	CBR			CONTROL, 0B01000000	; LINEA DE CONTROL PARA LA FUENTE EN RUTINA RELOJ SI EL VALOR MEDIDO
	CBR			CONTROL, 0B10000000	; LINEA DE CONTROL PARA LA FUENTE EN RUTINA RELOJ SI EL VALOR MEDIDO
TECLA4C2:	; OPCION PRODUCION AUTOMATICA MIDE CLORO  Y REDOX
	CPI			R17, 0B11100111		; TECLA CALIBRAR Y MAS
	BRNE		TECLA4D				; SI NO ESTA PULSADA SALTA
	LDI			R17, PA_PM
	LDI			R18, 1
	CALL		EEPROM_ES
	SET								; PONE A CERO EL BIT T DE SREG
	BLD			CONTROL_1,2			; PASA EL REGISTRO T A CONTROL_1



TECLA4D:	; PONER EL VALOR EN PANTALLA

	CPI			R17, 0B11110111		; TECLA CALI 
	BREQ		TECLA4F				; VA A PRESENTAR EN PAMTALLA TENSION E INTENSIDAD
	LDI			R22,00
	LDI				R16,32			; BORRA EL VALOR EN PANTALLA UNA VEZ POR SEGUNDO
	STS				$956,R16
	STS				$957,R16
	STS				$958,R16
	RCALL		PRO_TECLA
TECLA4D_1:
	CPI			R22,RETARDO3-5		; VALOR DEL TIEMPO DE RATARDO LECTURA DEL TECLADO
	BRLO		TECLA4D_1			; COMPRUEBA EL TIEMPO DE RETARDO DIGITO APAGADO

	MOV			R24, R30			; PONE EL VALOR EN R24 PARA CONVERTIRLO EN DECIMAL
	RCALL		RADC   				; CONVERTIR UN NUMERO EN DIGITOS DATO EN R24
	STS			$0956, R1			
	STS			$0957, R2			; PONE EL RESULTADO EN PANTALLA DECENAS DE PH
	STS			$0958, R3			; PONE EL RESULTADO EN PANTALLA UNIDADES DE PH
	RCALL		PRO_TECLA

TECLA4E:
	CPI			R22, RETARDO2		; VALOR DEL TIEMPO DE RATARDO LECTURA DEL TECLADO
	BRLO		TECLA4E				; COMPRUEBA EL TIEMPO DE RETARDO 
	RJMP		TECLA4	


TECLA4F:

;       20x4        16x4   tipo de display
; linea 1-128 		128 
; linea 2-192		192
; linea 3-148		144
; linea 4-212		208
	LDI				R16,148				; ESCRIBIR LINEA 3
	RCALL			ENVINT				; En subrrutina Env_doi Envia instrucion para escribir en linea 1
	LDI				YH, HIGH(L_BLANCA)	; POSICION BIT ALTO DEL TEXTO A ENVIAR ram en 070
	LDI				YL, LOW (L_BLANCA)	; POSICION BIT BAJO DEL TEXTO A ENVIAR
	LDI				R17,20				; NUMERO DE DIGITOS A ENVIAR A PANTALLA
	RCALL			ENVIARTEXTO			; RUTINA EN ESTE FICHERO PRECISA SUBRRUTINA ENV_DOI	

	LDI				R16,212				; ESCRIBIR LINEA 4
	RCALL			ENVINT				; En subrrutina Env_doi Envia instrucion para escribir en linea 1
	LDI				YH, HIGH(L_VOLTIOS)	; POSICION BIT ALTO DEL TEXTO A ENVIAR ram en 070
	LDI				YL, LOW (L_VOLTIOS)	; POSICION BIT BAJO DEL TEXTO A ENVIAR
	LDI				R17,20				; NUMERO DE DIGITOS A ENVIAR A PANTALLA
	RCALL			ENVIARTEXTO			; RUTINA EN ESTE FICHERO PRECISA SUBRRUTINA ENV_DOI	
	RJMP			TECLA4
