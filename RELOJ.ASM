; RUTINA RELOJ CONTROLA EL TIEMPO Y LA POLARIDAD

; CONTROL FUENTE OPTO
; 				MICRO PATA	1	PATA 2		LM358 PATA 1		OPTO		CLEMA
; ENCENDIDO					0		0				0,57		0,61		2,09
; APAGADO					0		5				3,55		1,14		0,06	

; VALORES % 9 25 41 57 73 89 O 91
; ************* GRABA LA MEDICION DE SAL EN EEPROM CONTROL ELECTRODO LO HACE EN EL 8% DEL CICLO******************
GRABA_SAL:
	LDI				R18, P_SAL			; LINEA DE ENTRADA EN EL CONVERTIDOR PCF8591
	LDS				R26, RAMC_SAL		; NUMERO DE MEDICIONES	
	CALL			ADC_P				; LEE LA MEDICION ACTUAL DE SAL
	MOV				R18,R24
	LDI				R17,POLARIDAD_0		; LEE LA POSICION EN EEPROM PARA GRABAR LA SAL POSICION 0
	SBIC			PORTD,7				; SALTA LA SIGUIENTE INSTRUCION SI ES 0	NO GRABA
	CALL			EEPROM_ES
	INC				R17					; INCREMENTA A LA POSICION POLARIDAD 1
	SBIC			PORTD,6				; SALTA LA SIGUIENTE INSTRUCION SI ES 0 NO GRABA				
	CALL			EEPROM_ES

; ACTIVA LA POLARIDAD MAS EFICAZ EN CASO DE SER DIFERENTES EN 5 DECIMAS
;CONTROL_POL:
	LDS				R17,SAL_ELECTRODO	;
	CPI				R17,00				; COMPARA CON 0
	BRNE			CONTROL_POL_1		; SI ES DISTINTO VA A CONTROL_POL_1
	RET									; SI ES IGUAL RETORNA AL PROGRAMA
CONTROL_POL_1:
	SBI				DDRB,0				; APAGA FUENTE
	LDI				R24,200
CONTROL_POL_2:
	LDI				R25, 250			; RETARDO TIEMPO QUE ESTA APAGADA LA FUENTE
	CALL			RETARDO				; RUTINA DE RETARDO
	DEC				R24					; DESCUENTA
	BRNE			CONTROL_POL_2		; SI NO ES CERO VA A PONTROL_POL_2
	LDI				R17,MEJOR_POLARIDAD	; POSICION EN EEPROM DE LA POLARIDAD MEJOR
	RCALL			EEPROM_RW			; LEE EL VALOR GRABADO



MOV		R24,R18
CALL	RADC
STS		$4EE,R3
	CPI				R24, 00				; COMPARA CON CERO
	BRNE			CONTROL_POL_3		; SI ES DISTINTO OSEA UN 1 VA A CONTROL_POL_3
	CBI				PORTD,6				; DESACTIVA EL RELE DE POLARIDAD
	SBI				PORTD,7				; ACTIVA POLARIDAD INVERSA
MOV				R16,VAL_LED
ANDI			R16,0B01111111		; APAGA LED 7 POLARIDAD
MOV				VAL_LED,R16

	CBI				DDRB,0				; SALIDA DEL 4N25 A CERO
	RET
CONTROL_POL_3:
	CBI				PORTD,7				; DESACTIVA EL RELE DE POLARIDAD
	SBI				PORTD,6				; ACTIVA POLARIDAD INVERSA
MOV				R16,VAL_LED
ORI				R16,0B10000000		; ENCIENDE LED 7 POLARIDAD
MOV				VAL_LED,R16


	CBI				DDRB,0				; ENCIENDE FUENTE
FIN:
	RET
RELOJ:									; ANULACION DE LA INTERMITENCIA DEL LED DE RED
	SET									; PONE EL REGISTRO T DE SREG A 1

;	BST				LEC_REL,0
	BLD				VAL_LED, 2			; COPIA T DE SREG EN REGISTRO 2 DE LOS LED ES INTERMITENTE 
	MOV				R16, VAL_LED
;	ORI				R16, 0B00000100		; ENCIENDE LED DE RED AZUL
	MOV				VAL_LED, R16	
CBI PORTE,7

;LDI				R18,58 ; PONE DOS PUNTOS
;STS				$7DF, R18

;BRTC RELOJ_B
;LDI				R18,32 ; PONE UN ESPACIO
;STS				$7DF, R18


;BRTC RELOJ_A		; SALTA SI EL BIT T DE SREG ES CERO
					; ESTO ES PARA ESCRIBIR UNA LINEA CADA SEGUNDO
;	LDI   			YH,high(LIN1)		; direccion alta del TEXTO en Ram
;	LDI   			YL,low (LIN1)		; direccion baja del TEXTO en Ram 
;	CALL 			UART_TXC_RAM		; RUTINA UART
;	LDS				R24, MINU
;	RCALL 			PANEL
;RJMP RELOJ_B
;RELOJ_A:
;	LDI   			YH,high(LIN2)		; direccion alta del TEXTO en Ram
;	LDI   			YL,low (LIN2)		; direccion baja del TEXTO en Ram 
;	CALL 			UART_TXC_RAM		; RUTINA UART
;	LDS				R24, NCICLOS
;	RCALL 			PANEL

RELOJ_B:
	RCALL			LEDPANT
	STS  			seg,lec_rel			; almacena los segundos en ram
	CPI  			lec_rel,t_ciclo		; comprueba que son UN MINUTO ....
	BRLO 			FIN					; SALTA AL FINAL

RELOJ1:
;	SBR				CONTROL,0B00000010	; PONE A UNO EL BIT 1
	SUBI 			lec_rel,t_ciclo		; PONE LOS SEGUNDOS A CERO Y SUMA UN MINUTO
	STS  			seg, lec_rel		; Y LO GRABA EN RAM
	MOV  			R24, lec_rel
	LDS				R19, MINU
	INC  			R19					; Y SUMA UNO
; ****************************GRABA EN  EEPROM LA MEDICION DE SAL Y MEJOR POLARIDAD********************************
	CPI				R19,9				; PARA GRABAR EN EEPRON LA CONCENTRACION DE SAL
	BRBC			1,RELOJ1_A1
	RCALL			GRABA_SAL			; 4% DE PRODUCION	CPI				R19, 9				; VERIFICA EL CONTADOR SI ES IGUAL A 20
;RELOJ1_A:
;	CPI				R19,8
;	BRBC			1,RELOJ1_A1
;	RCALL			CONTROL_POL
; NUEVOS VALORES CON CRISTAL DE CUARZO 8-22-35-48-61-74-87 INCREMENTO 13 EN VEZ DE 16


RELOJ1_A1:
	CPI				R19,10
	BRBC			1,RELIJ1B				; SI ES DISTINTO SALTA A RELIJ1B
	RCALL			L_HORA				; PARA INCREMENTAR LAS HORAS DE FUCIONAMIENTO	

RELIJ1B:
	CPI				R19, 25				; VERIFICA EL CONTADOR SI ES IGUAL A 40
	BRBC			1,RELOJ1C			; SI ES DISTINTO SALTA A RELOJ 1C
	RCALL			L_HORA				; PARA INCREMENTAR LAS HORAS DE FUCIONAMIENTO	

RELOJ1C:
	CPI				R19, 41				; VERIFICA EL CONTADOR SI ES IGUAL A 60
	BRBC			1, RELOJ1D			; SI ES DISTINTO SALTA A RELOJ 1D
	RCALL			L_HORA				; PARA INCREMENTAR LAS HORAS DE FUCIONAMIENTO	
RELOJ1D:
	CPI				R19, 57				; VERIFICA EL CONTADOR SI ES IGUAL A 80
	BRBC			1, RELOJ1E				; SI ES DISTINTO SALTA A RELOJ 1E
	RCALL			L_HORA				; PARA INCREMENTAR LAS HORAS DE FUCIONAMIENTO	
RELOJ1E:
	CPI				R19, 73				; VERIFICA EL CONTADOR SI ES IGUAL A 80
	BRBC			1, RELOJ1F			; SI ES DISTINTO SALTA A RELOJ 1F
	RCALL			L_HORA				; PARA INCREMENTAR LAS HORAS DE FUCIONAMIENTO	
RELOJ1F:
	CPI				R19, 89				; VERIFICA EL CONTADOR SI ES IGUAL A 80
	BRBC			1, RELOJ1A			; SI ES DISTINTO SALTA A RELOJ 1A
	RCALL			L_HORA				; PARA INCREMENTAR LAS HORAS DE FUCIONAMIENTO	

RELOJ1A:

	CPI				R19, 106			; MINUTOS POR CICLO ( INVIERTE) 3 DE ESPERA CON FUENTE APAGAA
	BRBS			0, RELOJ2			; SI NO ES 106 SALTA A RELOJ2
	LDS				R19, NCICLOS
	INC				R19
	STS				NCICLOS, R19
		SET									; PONE A 1 EL REGISTRO T DE SREG
		BLD				CONTROL_1,7			; LINEA DE CONTROL 7 SE HA PRODUCIDO UNA INVERSION DE POLARIDAD
	LDS				R18, RAM_CICLOS
	CP				R19, R18			; CICLOS PARA LA INVERSION
	BRBS			0, RELOJ2


; ENVIO DE INFORMACION AL PANEL POR CABLE O RADIO UNA VEZ POR PERIODO
;  A Q U I
; INVIERTE LA POLARIDAD
	LDI				R19,00				; AQUI PONE LOS MINUTOS A CERO
	STS				NCICLOS,R19			; Y LO GRABA EN RAM
	STS				MINU,R19			; Y LO ALMACENA EN RAM

	LDI				LEC_REL,30			; PARA NO ESPERAR EN CASO DE INVERSION DE POLARIDAD
	MOV				R16,VAL_LED
	ANDI			R16,0B10000000		; TODO A CERO MENOS BIT 7 QUE CONSERVA SU VALOR
	CPI				R16,0B10000000		; VERIFICA POLARIDAD ACTUAL PARA INVERTIR
	BREQ			RELOJ1B
	ORI				R16,0B10000000		; ENCIENDE LED 7 POLARIDAD
	MOV				VAL_LED,R16
	CBI				PORTD,7				; DESACTIVA RELE POLARIDAD
	SBI				PORTD,6				; ACTIVA EL RELE DE LA POLARIDAD
	CALL			COMPARA2
	RJMP			RELOJ2
RELOJ1B:
	CBI				PORTD,6				; DESACTIVA EL RELE DE POLARIDAD
	SBI				PORTD,7				; ACTIVA POLARIDAD INVERSA
	ORI				R16,0B10000000		; ENCIENDE LED 7 POLARIDAD
	MOV				VAL_LED,R16
RELOJ2:
	STS  			minu,R19			; Y LO ALMACENA EN RAM
	LDS				R18,RAMP_PRO		; CARGA EL PORCENTAJE DE PRODUCION DE RAM AL REGISTRO
; REDUCION POR CUBIERTA CERRADA
;	SBRC			CONTROL_1, 3
;	CALL			MULTIPLICAR_A		; TIENE LA CUBIERTA CERRADA Y REDUCE EL PORCENTAJE DE PRODUCION
	SBRC			CONTROL,3			; SALTA LA PROXIMA INSTRUCION SI ES CERO, SUPERCLORACION
	LDI				R18,100
	CPI				R19,01				; VERIFICA QUE A PASADO UN MINUTO PARA ENCENDER LA FUENTE
	BRBS			0,NO				; SI ES MENOR DE UN MINUTO SALTA A NO
	CPC				R19,R18				; SI EL TIEMPO ES INFERIOR A LA PRODUCION NO APAGA VA A ENCENDER FUENTE
	BRBS			0,ENCENDER
APAGAR:
	SBRC			CONTROL,7 			; COMPRUEBA SI TIENE SONDA DE CLORO LIBRE
	RET									; SI NO TIENE SALTA ESTA INSTRUCION
	SBRC			CONTROL,6			; COMPRUEBA SI TIENE SONDA DE REDOX
	RET									; SI NO TIENE SALTA ESTA INSTRUCION
APAGAR_FUENTE:
	SBI				DDRB,0				; SALIDA DEL 4N25 A CERO
	CBI				PORTD,4				; APAGA CONTROL REMOTO Y VENTILADOR
	SBI				PORTC,0				; SALIDA PARA EL CONTROL DEL EQUIPO REMOTO APAGADO
	LDI				R16,0B00010000		; APAGA LOS MOS-FET
	STS				PORTG,R16
	MOV				R16,VAL_LED
	ANDI			R16,0B01111100		; APAGA LED 0 FUENTE ENCENDIDA
	MOV				VAL_LED,R16	
;		LDI			R19,116			; ENVIA UNA t			
;		LDI			R27,55			; TEXTO 7 

	RET
ENCENDER:
	SBRC			CONTROL,7 			; COMPRUEBA SI TIENE SONDA DE CLORO LIBRE
	RET									; SI NO TIENE SALTA ESTA INSTRUCION
	SBRC			CONTROL,6			; COMPRUEBA SI TIENE SONDA DE REDOX
	RET									; SI NO TIENE SALTA ESTA INSTRUCION
ENCENDER_FUENTE:

;	SBRS			CONTROL_1,4			; SALTA LA PROXIMA INSTRUCION SI ES UNO
;	RJMP			APAGAR_FUENTE		; ERROR SI ES CERO
;**************************************** ojo no enciende la fuente ***********************************
	CBI				DDRB,0				; SALIDA DEL 4N25 A 1 
;SBI DDRB,0 ; AQUI APAGA LA FUENTE PARA LA FERIA EN VEZ DE ENCENDERLA
	SBI				PORTD,4				; ACTIVA CONTROL REMOTO Y VENTILADOR
	CBI				PORTC,0				; SALIDA PARA EL CONTROL DEL EQUIPO REMOTO APAGADO
	LDI				R16,0B00000001		; ENCENDER SALIDA CONTROL REMOTO
	STS				PORTG,R16
	MOV				R16,VAL_LED
	ORI				R16,0B00000011		; ENCIENDE LED 0 FUENTE ENCENDIDA
	MOV				VAL_LED,R16	
;	SBR 			CONTROL, 0B00000010	; ACTIVA LA SEÑAL PARA MEDIR EL PH ANTES DEL ARRANQUE DE LA FUENTE
;		LDI			R19,116			; ENVIA UNA t			
;		LDI			R27,55			; TEXTO 7 

NO:
	RET									; TERMINA LA RUTINA


; MEDICION DE HORAS DE FUNCIONAMIENTO EN N_HORAS VIENE DE LA LINEAN 45
; SI LA FUENTE ESTA APAGADO RETORNA
L_HORA: ; INCREMENTA FRACIONES DE HORA

	SBIS			PIND,4				; SI LA FUENTE ESTA APAGADA SALTA A NO
	JMP				NO					; NO CUENTA FRACION DE HORA
	LDI				R17,N_MIN20			; POSICION FRACIONES DE HORA DE HORA
	CALL			EEPROM_RW			; LEE EN LA EPROM
	INC				R18					; INCREMENTA UN SESTO
CPI				R18,6				; COMPRUEBO SI SON YA LOS 6 
	BRNE			L_HORA_2			; SI NO SON VA A L_HORA_2 Y GRABA EL NUEVO DATO EN EPROM			
	LDI				R18,00				; COMO YA VAN 6  
	CALL			EEPROM_ES			; BORRA LA EPROM Y SUMA UNA HORA


L_HORA_1:

	CALL			REJILLA				; CALCULO VIDA DE LA REJILLA
	LDI				R17, N_HORAS		; POSICION A LEER EN LA EEPROM
	RCALL			EEPROM_RW			; RUTINA LECTURA EEPROM DEVUELVE EL VALOR EN R18
	MOV				YL, R18				; RESULTADO EN R18
	LDI				R17, N_HORAS_1		; POSICION A LEER EN LA EEPROM
	RCALL			EEPROM_RW			; RUTINA LECTURA EEPROM DEVUELVE EL VALOR EN R18
	MOV				YH, R18				; RESULTADO EN R18
ADIW			YH:YL, 1			; INCREMENTA EN 1 CON ACARREO
	MOV				R18, YL				; PASA A R18 EL VALOR A GRABAR EN EEPROM
	LDI				R17, N_HORAS		; POSICION A ESCRIBIR EN LA EEPROM POSICION BAJA
	RCALL			EEPROM_ES			; RUTINA LECTURA EEPROM DEVUELVE EL VALOR EN R18
	MOV				R18, YH				; PASA A R18 EL VALOR A GRABAR EN EEPROM
	LDI				R17, N_HORAS_1		; POSICION A ESCRIBIR EN LA EEPROM PASICION ALTA
	RCALL			EEPROM_ES			; RUTINA LECTURA EEPROM DEVUELVE EL VALOR EN R18
	RJMP			L_HORA_1A			; DUPLICA DATOS

L_HORA_2:
	CALL			EEPROM_ES

	RET			
; DUPLICAR REGISTROS DE HORAS

L_HORA_1A:

	LDI				R17, N_HORASC		; POSICION A LEER EN LA EEPROM
	RCALL			EEPROM_RW			; RUTINA LECTURA EEPROM DEVUELVE EL VALOR EN R18
	MOV				YL, R18				; RESULTADO EN R18
	LDI				R17, N_HORASC_1		; POSICION A LEER EN LA EEPROM
	CALL			EEPROM_RW			; RUTINA LECTURA EEPROM DEVUELVE EL VALOR EN R18
	MOV				YH, R18				; RESULTADO EN R18
	ADIW			YH:YL, 1			; INCREMENTA EN 1 CON ACARREO
	MOV				R18, YL				; PASA A R18 EL VALOR A GRABAR EN EEPROM
	LDI				R17, N_HORASC		; POSICION A ESCRIBIR EN LA EEPROM POSICION BAJA
	CALL			EEPROM_ES			; RUTINA LECTURA EEPROM DEVUELVE EL VALOR EN R18
	MOV				R18, YH				; PASA A R18 EL VALOR A GRABAR EN EEPROM
	LDI				R17, N_HORASC_1		; POSICION A ESCRIBIR EN LA EEPROM PASICION ALTA
	RCALL			EEPROM_ES			; RUTINA LECTURA EEPROM DEVUELVE EL VALOR EN R18
	RET
;PRU2: ;PONE EN LA TERCERA LINEA LA FRACION DE HORA
	LDI				R17,N_MIN20
	CALL			EEPROM_RW
	MOV				R24,R18
	CALL			RADC
	STS				$250,R1
	STS				$251,R2
	STS				$252,R3	
	RET

; ESTO ES PARA PRODUCIR UNA INTERMITENCIA EN EL RELE DE PH
BST				LEC_REL, 0			; COPIA EL BIT CERO DE LA LECTURA DEL RELOJ EN T
BRTS			PRU3
CBI				PORTD,b_acido		; ENCIENDE BOMBA DE ACIDO
RJMP PRU4
PRU3:
SBI				PORTD,b_acido		; APAGA BOMBA DE ACIDO
PRU4:	
