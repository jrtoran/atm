; RUTINA PARA EL CALCULO APROXIMADO EL DETERIORO DEL ELECTRODO
; PRIMERO MULTIPLICAR POR 3
; SEGUNDO MLTIPLICAR POR . 3/DETERIORO  Y DIVIDIR 256 ENTRE EL RESULTADO UNA CHAPUZA
; RESULTADO EN R16
; GRABA EL RESULTADO EN EEPRON POSICION 9C
;					VALOR DE R18
; 0-1 DESGASTE 		NO FUNCIONA
; 1-2 DESGASTE 3 	VALOR 255
; 2-3 DESGASTE 2,5 	VALOR 214
; 3-4 DESGASTE 2	VALOR 171
; 4-5 DESGASTE 1,5	VALOR 128
; 5-6 DESGASTE 1	VALOR 86
; <-6 DESGASTE 1	VALOR 86
; EL RESULTADO EN R1

DES_ELECTRODO:							;0-1
CLR XH
	LDI				R17,REG_REJILLA			; POSICION DE MEMORIA A LEER EN EEPROM 050
	CALL			EEPROM_RW				; RUTINA LECTURA EEPROM DEVUELVE EL VALOR EN R18
	MOV				YL,R18					; RESULTADO EN R18 Y LO PASA A YL VALOR BAJO
	LDI				R24,8					; INCREMENTA EL VALOR PARA LEER LA POSICION ALTA
	ADD				R17,R24
	CALL			EEPROM_RW				; LEE LA EEPROM POSICION ALTA
	MOV				YH,R18					; Y LO PASA A YH VAL0R ALTO
	SBRC			YL,7					; VERIFICA EL BIT 7 SI EL REGISTRO TIENE UN VALOR SUPERIOR A 125
	INC				YH						; SI ES MAYOR INCREMENTA EL REGISTRO ALTO
;LDI YH,00
	LDI				R18,255					; POR 3
	CALL			DES_ELECTRODO_A

	LDI				R17,REG_REJILLA	+ 1		;1 - 2  "255"
	CALL			EEPROM_RW				; RUTINA LECTURA EEPROM DEVUELVE EL VALOR EN R18
	MOV				YL,R18					; RESULTADO EN R18 Y LO PASA A YL VALOR BAJO
	LDI				R24,8					; INCREMENTA EL VALOR PARA LEER LA POSICION ALTA
	ADD				R17,R24
	CALL			EEPROM_RW				; LEE LA EEPROM POSICION ALTA
	MOV				YH,R18					; Y LO PASA A YH VAL0R ALTO
	SBRC			YL,7					; VERIFICA EL BIT 7 SI EL REGISTRO TIENE UN VALOR SUPERIOR A 125
	INC				YH						; SI ES MAYOR INCREMENTA EL REGISTRO ALTO
;LDI YH,00
	LDI				R18,255					; POR 3
	CALL			DES_ELECTRODO_A

	LDI				R17,REG_REJILLA	+ 2		;2 - 3
	CALL			EEPROM_RW				; RUTINA LECTURA EEPROM DEVUELVE EL VALOR EN R18
	MOV				YL,R18					; RESULTADO EN R18 Y LO PASA A YL VALOR BAJO
	LDI				R24,8					; INCREMENTA EL VALOR PARA LEER LA POSICION ALTA
	ADD				R17,R24
	CALL			EEPROM_RW				; LEE LA EEPROM POSICION ALTA
	MOV				YH,R18					; Y LO PASA A YH VAL0R ALTO
	SBRC			YL,7					; VERIFICA EL BIT 7 SI EL REGISTRO TIENE UN VALOR SUPERIOR A 125
	INC				YH						; SI ES MAYOR INCREMENTA EL REGISTRO ALTO
;LDI YH, 20
	LDI				R18,214					; POR 2,5
	CALL			DES_ELECTRODO_A

	LDI				R17,REG_REJILLA	+ 3		;3 - 4
	CALL			EEPROM_RW				; RUTINA LECTURA EEPROM DEVUELVE EL VALOR EN R18
	MOV				YL,R18					; RESULTADO EN R18 Y LO PASA A YL VALOR BAJO
	LDI				R24,8					; INCREMENTA EL VALOR PARA LEER LA POSICION ALTA
	ADD				R17,R24
	CALL			EEPROM_RW				; LEE LA EEPROM POSICION ALTA
	MOV				YH,R18					; Y LO PASA A YH VAL0R ALTO
	SBRC			YL,7					; VERIFICA EL BIT 7 SI EL REGISTRO TIENE UN VALOR SUPERIOR A 125
	INC				YH						; SI ES MAYOR INCREMENTA EL REGISTRO ALTO
;LDI YH,0
	LDI				R18,171					; POR 2
	CALL			DES_ELECTRODO_A

	LDI				R17,REG_REJILLA	+ 4		;4 - 5
	CALL			EEPROM_RW				; RUTINA LECTURA EEPROM DEVUELVE EL VALOR EN R18
	MOV				YL,R18					; RESULTADO EN R18 Y LO PASA A YL VALOR BAJO
	LDI				R24,8					; INCREMENTA EL VALOR PARA LEER LA POSICION ALTA
	ADD				R17,R24
	CALL			EEPROM_RW				; LEE LA EEPROM POSICION ALTA
	MOV				YH,R18					; Y LO PASA A YH VAL0R ALTO
	SBRC			YL,7					; VERIFICA EL BIT 7 SI EL REGISTRO TIENE UN VALOR SUPERIOR A 125
	INC				YH						; SI ES MAYOR INCREMENTA EL REGISTRO ALTO
;LDI YH, 00
	LDI				R18,128					; POR 1,5
	CALL			DES_ELECTRODO_A

	LDI				R17,REG_REJILLA	+ 5		; 5 -6 				;
	CALL			EEPROM_RW				; RUTINA LECTURA EEPROM DEVUELVE EL VALOR EN R18
	MOV				YL,R18					; RESULTADO EN R18 Y LO PASA A YL VALOR BAJO
	LDI				R24,8					; INCREMENTA EL VALOR PARA LEER LA POSICION ALTA
	ADD				R17,R24
	CALL			EEPROM_RW				; LEE LA EEPROM POSICION ALTA
	MOV				YH,R18					; Y LO PASA A YH VAL0R ALTO
	SBRC			YL,7					; VERIFICA EL BIT 7 SI EL REGISTRO TIENE UN VALOR SUPERIOR A 125
	INC				YH						; SI ES MAYOR INCREMENTA EL REGISTRO ALTO
;LDI YH,00
	LDI				R18,86					; por 1
	CALL			DES_ELECTRODO_A


	LDI				R17,REG_REJILLA	+ 6		; MAS DE 6
	CALL			EEPROM_RW				; RUTINA LECTURA EEPROM DEVUELVE EL VALOR EN R18
	MOV				YL,R18					; RESULTADO EN R18 Y LO PASA A YL VALOR BAJO
	LDI				R24,8					; INCREMENTA EL VALOR PARA LEER LA POSICION ALTA
	ADD				R17,R24
	CALL			EEPROM_RW				; LEE LA EEPROM POSICION ALTA
	MOV				YH,R18					; Y LO PASA A YH VAL0R ALTO
	SBRC			YL,7					; VERIFICA EL BIT 7 SI EL REGISTRO TIENE UN VALOR SUPERIOR A 125
	INC				YH						; SI ES MAYOR INCREMENTA EL REGISTRO ALTO
;LDI YH,00
	LDI				R18,86					; por 1
	CALL			DES_ELECTRODO_A



STS $403,XH		; posicion de almacenamiento en ram
ldi r17,des_elect	; posicion en eeprom 9b
mov r18,XH

call eeprom_es

CALL	CAL_DESGASTE

	RET


DES_ELECTRODO_A:
cpi yh,255				; COMPARA CON FF SI ES DISTINTO
brne DES_ELECTRODO_B	; VA A DES_ELECTRODO_B
ret						; SI ES IGUAL NO CUENTA RETORNA


DES_ELECTRODO_B:
; PRIMERO MULTIPLICA POR 3
	MOV R19,YH
	LSL YH
	ADD YH,R19
; AQUI DIVIDE POR ALGO VER VALOR DE R18 EN LA TABLA SUPERIOR SEGUN LA SAL .RESULTADO EN R1
	MUL YH,R18
; SUMA EL RESULTADO A R24 DA LAS HORAS SEGUN DESGASTE 
	ADD XH,R1
	RET

; CALCULA EL % DE DESGASTE
CAL_DESGASTE:
	LDI				XL,33		; 33X3=99%
	SUB				XL,XH		; LE RESTA 33 QUE SERIA EL 99%
	LDI				XL,3		; MULTIPLICA POR 3
	MUL				XH,XL
LDI R18,100
SUB R18,R0
CPI R18,101			; PARA CUANDO HAY DESBORDAMIENTO PONE R18 A 00 SI NO NO
BRLO			CAL_DESGASTE_1	; SALTA SI ES MENOR
LDI			R18,00
CAL_DESGASTE_1:					; SALTA SI ES MENOR
ldi r17,des_elect + 1	; posicion en eeprom 9C
call eeprom_es			; ESCRIBE EN EEPRON EL PORCENTAJE DE DESGASTE

; PRESENTA EN PANTALLA 20X4 LINEA 4 EL DESGASTE Y EN LA RUTINA PROGRAMACION DE CICLOS
MOV R24, R18
CALL RADC
;STS $220,R1
STS $7A0,R1
;STS $221,R2
STS $7A1,R2
;STS $222,R3
STS $7A2,R3
;	LDI				R16,227			; 11000000 escribir en linea 4 linea (192)( linea 4 seria 212)
;	CALL			ENVINT
;	LDI				YH,HIGH(PRUEBA_2)	; POSICION ALTA DEL TAXTO EN RAM 220
;	LDI				YL,LOW (PRUEBA_2)	; direccion BAJA DEL TEXTO EN RAM      	
 ; 	LDI				R17,3   			; bytes a enviar 
;	CALL			ENVIARTEXTO			; RUTINA PARA ENVIAR TEXTO E PANRALLA


		
RET
