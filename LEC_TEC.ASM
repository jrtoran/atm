; RUTINA PARA LA PROGRAMACION DE PARAMETROS PH,CL REDOX Y PRODUCCION
; 1º VERIFICA SI SE HA PULSADO LA TECLA 00000001
; PARA PODER ENTRAR EN PROGRAMACION APARTADO TECLADO
; 2º LEE LOS VALORES DE LOS PARAMETROS EN LA EEPROM
; Y LOS ALMACENA EN R30, R31, r28 APARTADO TECLA
; 3º ENTRA EN AJUSTE DEL PH TECLA1*
; EN EL APARTADO TECLA1A SE VERIFICA LA OPCION PASAR A CL( 6 Y 2) Ó SALIR (6 Y 4)
; TECLA1B PULSANDO LA TECLA 3 AUMENTA
; TECLA1C PULSANDO LA TECLA 4 DISMINUYE
; EN EL REGISTRO R7 SE CUENTA EL RETARDO SIN PULSAR TECLAS
; RUTINA PARA LA LECTURA DEL TECLADO ALMACENA EL VALOR EN RAM $241

;DTP:	; OPCION CALIBRAR PARA DTP PULSAR FLECHA CALIBRAR Y PROGRAMAR
;	LDS			R24, $0328
;	CPI			R24, 84
;	BRNE		DTP2					; SI NO ES IGUAL SALTA A DTP1 NO VA A CALIBRAR
;	RET	
;DTP2:
;	RJMP		LEC2A

;CUBIERTA:
;	SET								; PONE A 1 EL REGISTRO T DE SREG
;	BLD			CONTROL_1, 3		; LINEA DE CONTROL 3 CUBIERTA CERRADA APLICA PORCENTAJE DE PRODUCION	
;	RET


TECLADO:
;CALL		DATO_ASCI				; MUESTRA EN PANTALLA ASCI LOS VALORES DE RG_232 LA RUTINA ESTA EN PRO_PAR
	LDS			R18,RG_232+1		; ES LA POSICION DONDE GRABA LA PANTALLA DONDE ESTA SE USA EN LA RUTINA PAGE
	CPI			R18,9	
	BRNE		TECLADO_1			; SI ESTA LA NEXTION EN PANTALLA DE DATOS DEL EQUIPO NO VERIFICA NADA MAS
	RCALL		LIN_PGRAFICA		; ENVIA LOS DATOS	
	RET

LEC2A:		; CALIBRAR SAL Y PH
	MOV			R16, VAL_LED		; ENCIENDE LUZ PANTALLA
	ORI			R16, 0B01000000
	MOV			VAL_LED, R16
	RCALL		LEDPANT				; ACTUALIZAR LOS LED DE LA PANTALLA	
	RJMP		PRO6				; RUTINA CALIBRACIN SAL Y PH


;C_POLARIDAD:
;	LDI			R19, 108
;	STS			MINU, R19
;	LDI			LEC_REL, 30
;	LDI			R19, 3
;	STS			NCICLOS, R19
;	RET
;INVIERNO:
;	LDI			R17, VER_INV		; POSICION  EN EEPROM $011
;	LDI			R18, 0
;	RCALL		EEPROM_ES
;	MOV			R16, VAL_LED
;	ORI			R16, 0B00000010		; ENCIENDE LED VERANO INVIERNO
;	MOV			VAL_LED, R16
;	SBR			CONTROL, 0B00000100	; ENCIENDE LED INVIERNO
;	RET

LEC2B:		; CALIBRAR CLORO Y REDOX
	MOV			R16, VAL_LED		; ENCIENDE LUZ PANTALLA
	ORI			R16, 0B01000000
	MOV			VAL_LED, R16
	RCALL		LEDPANT				; ACTUALIZAR LOS LED DE LA PANTALLA	
	RJMP		PRO7				; RUTINA CALIBRACIN CLORO Y REDOX



LEC2D:		; PRESENTACION DE LA TEMPERATURA AL PULSAR SALIR   OOJJOO  PRESENTA EN PANTALLA 2
;	CALL			BORRAR_PANTALLA
;RJMP TECLADO
;       20x4        16x4   tipo de display
; linea 1-128 		128 
; linea 2-192		192
; linea 3-148		144
; linea 4-212		208
	LDI				R18,P_TEMP			; LINEA A LEER
	LDI				R26,80				; NUMERO DE LECTURAS
	CALL			ADC_P
;LDI R24,00
	STS				RAM_TEMP,R24		; GUARDA LA LECTURA EN LA MEMORIA RAM
	CALL			PCF2_T				; RUTINA QUE PREPARA LA PRESENTACION DE LA TEMPERATURA

	LDI				R16, 148		; ESCRIBIR LINEA 3 PRESENTA LA TEMPERATURA
	RCALL			ENVINT			; En subrrutina Env_doi Envia instrucion para escribir en linea 1
	LDI				YH, HIGH (LIN4)	; POSICION BIT ALTO DEL TEXTO A ENVIAR
	LDI				YL, LOW  (LIN4)	; POSICION BIT BAJO DEL TEXTO A ENVIAR
	LDI				R17,20			; NUMERO DE DIGITOS A ENVIAR A PANTALLA
	RCALL			ENVIARTEXTO		; RUTINA EN ESTE FICHERO PRECISA SUBRRUTINA ENV_DOI	
	CALL			PCF2_T			; PRESENTA LA TEMPERATUTA
	CALL			HORAS			; PRESENTA HORAS Y AMPERIOS (PROD CLORO)
	LDI				R16,192
	RCALL			ENVINT
	LDI				YH, HIGH (VIDA_ELECT)	; POSICION BIT ALTO DEL TEXTO A ENVIAR
	LDI				YL, LOW  (VIDA_ELECT)	; POSICION BIT BAJO DEL TEXTO A ENVIAR
	LDI				R17,20			; NUMERO DE DIGITOS A ENVIAR A PANTALLA
	RCALL			ENVIARTEXTO		; RUTINA EN ESTE FICHERO PRECISA SUBRRUTINA ENV_DOI	
	LDI				R16,128
	RCALL			ENVINT
	LDI				YH, HIGH (USO_EQUIPO)	; POSICION BIT ALTO DEL TEXTO A ENVIAR
	LDI				YL, LOW  (USO_EQUIPO)	; POSICION BIT BAJO DEL TEXTO A ENVIAR
	LDI				R17,20			; NUMERO DE DIGITOS A ENVIAR A PANTALLA
	RCALL			ENVIARTEXTO		; RUTINA EN ESTE FICHERO PRECISA SUBRRUTINA ENV_DOI	
	SBRS			CONTROL_1,6		; SALTA LA PROXIMA INSTRUCION SI ES CERO,
	RJMP			LEC2D1			; PRESENTA EL TEXTO "SENSOR DE FLUJO"
	CALL			BORRA_LINEA_4
	RJMP			TECLADO
LEC2D1:
	LDI				R16, 212		; ESCRIBIR LINEA 4 PRESENTA SENSOR DE FLUJO
	RCALL			ENVINT			; En subrrutina Env_doi Envia instrucion para escribir en linea 1
	LDI				YH, HIGH (SENSOR_CAUDAL)	; POSICION BIT ALTO DEL TEXTO A ENVIAR
	LDI				YL, LOW  (SENSOR_CAUDAL)	; POSICION BIT BAJO DEL TEXTO A ENVIAR
	LDI				R17,20			; NUMERO DE DIGITOS A ENVIAR A PANTALLA
	RCALL			ENVIARTEXTO		; RUTINA EN ESTE FICHERO PRECISA SUBRRUTINA ENV_DOI	


; TECLA 0 PROGRAMAR		0B11111110		FE	254
; TECLA 1 MENOS			0B11111101		FD	253
; TECLA 2 FLECHA		0B11111011		FB	251
; TECLA 3 CALIBRAR		0B11110111		F7	247
; TECLA 4 MAS			0B11101111		EF	239
; TECLA 5 CAUDAL
; TECLA 6 NIVEL ACIDO
; TECLA 7 SALIR			0B01111111		7F	127


TECLADO_1:
	CALL		LEC_TECB			; VA A COMPROBAR LA OPCION NEXTION
	RCALL		LEC_TEC

	CPI			R17, 0B11110111		; RUTINA AJUSTE SAL Y PH 								" CALIBRAR "
	BREQ		LEC2A

	WDR
;	CPI			R17, 0B11101001		; FUERZA EL CAMBIO DE POLARIDAD					"FLECHA MAS Y MENOS"
;	BREQ		C_POLARIDAD
	CPI			R17, 0B01101111		; ACTIVA RELE DE PH Y CONTROL REMOTO DEL ESCLAVO 	 	"MAS Y SALIR"
	BREQ		ACT_RELE_PH

;	CPI			R17, 0B11110010		; OPCIONAL DTP											;FLECHA PROGRAMAR CALIBRAR 
;	BREQ		LEC2A
;	CPI			R17, 0B11100111		; INVIERNO												ANULADA "CALIBRAR Y MAS"
;	BREQ		PONER_AJUSTE1		; PONE EN PANTALLA DATOS RUTINA PWM_ATMEGA

;	BREQ		INVIERNO
;	CPI			R17, 0B10011111		;  REDUCE LA PRODUCION POR TENER CUBIERTA ATOMATICA		ANULADA
;	BREQ		CUBIERTA
;JMP PONER_AJUSTE ;SI SE ACTIVA SALE EL TEXTO DE MOST Y SHUN EN LA PARTE DE ARRIBA DE LA PANTALLA
;	CPI			R17, 0B11110101		; VERANO												"CALIBRAR Y MENOS
;	BREQ		VERANO
;	BREQ		PONER_AJUSTE1		; PONE EN PANTALLA DATOS RUTINA PWM_ATMEGA

	CPI			R17, 0B11111001		; DESACTIVAR_SUPER_CLORACION 							"FLECHA Y MENOS"
	BREQ		DESACTIVAR_SUPER_CLORACION
	CPI			R17, 0B11101011		; ACTIVAR_SUPER_CLORACION 								"FLECHA Y MAS
	BREQ		ACTIVAR_SUPER_CLORACION

	CPI			R17, 0B11101100		; RUTINA AJUSTE CLORO Y REDOX 							"PROGRAMAR MENOS Y MAS"
	BREQ		LEC2B
;	CPI			R17, 0B10111111		; RUTINA NIVEL DE ACIDO									EN PANTALLA
;	BREQ		LEC2C
;	MOV			R24, VAL_LED
;	ANDI		R24, 0B11011111		; APAGA LED NIVEL DE ACIDO ES FICTICIO EL 5 NO SALE EN PANTALLA
;	MOV			VAL_LED, R24
	CPI			R17, 0B01111111		; PARA USO EQUIPO TEMPERATURA ETC						"SALIR"
	BREQ		LEC2D

	CPI			R17, 0B11111110		; TECLA 1 ENTRA EN PROGRAMACION DE VALORES 				"PROGRAMAR"
	BREQ		TECLA4VR			; SI ESTAN PULSADAS VA A TECLA4VR Y LUEGP A TECLA4V PRODUCION

	CPI			R17, 0B01110010		; ENTRA EN PROGRAMACION MODELO Y DISTRIBUIDOR	"FLECHA, CALIBRAR SALIR Y PROGRAMAR" POR ESTE ORDEN
	BREQ		INICIO				; FLECHA CALIBRAR PROGRAMAR Y SALIR
;	CPI			R17,0B11011111		; CONTROL DE CAUDAL EN PANTALLA CLEMA
;	BREQ		SIN_CAUDAL
;	BLD			R17, 5

; ESTAS DOS LUNEAS oo jj oo ********* HAY QUE ACTIVARLAS ^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^^
	SBIS		PINE,4				; SONDA DE CAUDAL NUEVA TOMA EN EL MISMO PCB
	RJMP		SIN_CAUDAL
	
	LDI			R19,0
	STS			S_FLUJO,R19			; DESACTIVA LA SEÑAL DEL SENSOR

	RET
;PONER_AJUSTE1:				;****** PRESENTA EN LINEA 1 % MOS Y SEÑAL DEL SHUNT
;	JMP			PONER_AJUSTE		; PONE EN PANTALLA DATOS RUTINA PWM_ATMEGA

ACTIVAR_SUPER_CLORACION:
	SBR			CONTROL, 0B00001000
	CALL		ENCENDER_FUENTE
	RET
DESACTIVAR_SUPER_CLORACION:
	CBR			CONTROL, 0B00001000
	RET

TECLA4VR:	; INSTRUCION DE REPLICA
	JMP			TECLA4V
ACT_RELE_PH:
	JMP			RELE_PH

INICIO:
	CALL		AJUSTE_PRESENTACION_INICIO		; ANTERIORMENTE SIN EL "_INICIO"
	RET
CUBIERTA_ABIERTA:
	CLT								; PONE A 0 EL REGISTRO T DE SREG
	BLD			CONTROL_1, 3		; LINEA DE CONTROL 3 CUBIERTA ABIERTA NO APLICA PORCENTAJE DE PRODUCION	
	RET




;SIN_CAUDAL: ; APAGA LA FUENTE Y LA BOMBA DE PH LECTURA UNA VEZ POR SEGUNDO

SIN_CAUDAL:
	SBRS			CONTROL_1,0			; SALTA LA PROXIMA INSTRUCION SI ES UNO,
	RJMP			SIN_CAUDAL			; RETARDO UN SEGUNDO
	CLT									; LIMPIA EL REGISTRO T
	BLD				CONTROL_1, 0		; PASA EL REGISTRO T A CONTROL_1
	SET
	BLD				CONTROL_1,6
	LDI				R16,1
	STS				BAJO_SAL,R16
	CALL			CADENA_UART

SIN_CAUDAL_1:
	SBRS			CONTROL_1,0			; SALTA LA PROXIMA INSTRUCION SI ES UNO,
	RJMP			SIN_CAUDAL_1			; RETARDO UN SEGUNDO
	CLT									; LIMPIA EL REGISTRO T
	BLD				CONTROL_1, 0		; PASA EL REGISTRO T A CONTROL_1
	CLT
	BLD				CONTROL_1,6
	LDI				R16,0
	STS				BAJO_SAL,R16
	CALL			CADENA_UART



	RCALL		LEDPANT				; ACTUALIZAR LOS LED DE LA PANTALLA	
	CALL		APAGAR_FUENTE
	CBI			PORTD,b_acido		; APAGA BOMBA DE ACIDO b_acido es 5
	LDI			LEC_REL, 50			; PONE EN EL CONTADOR DEL RELOJ EL TIEMPO DE RETARDO POR FALTA DE FLUJO
	MOV			R16, VAL_LED
	ANDI		R16, 0B11101110		; APAGA LED 0, FUENTE APAGADA, LLENADO PISCINA Y PH LED 4
	MOV			VAL_LED, R16	
	RCALL		LEDPANT				; ACTUALIZAR LOS LED DE LA PANTALLA	
	LDI			R16, 128			; ESCRIBIR LINEA 1 VER QUE PASA CON VALOR 1
	RCALL		ENVINT				; En subrrutina Env_doi Envia instrucion para escribir en linea 1
	LDI			YH,HIGH (LIN_CA)	; POSICION BIT ALTO DEL TEXTO A ENVIAR "SIN CAUDAL"
	LDI			YL,LOW  (LIN_CA)-2	; POSICION BIT BAJO DEL TEXTO A ENVIAR
	LDI			R17,20				; NUMERO DE DIGITOS A ENVIAR A PANTALLA
	RCALL		ENVIARTEXTO			; RUTINA EN ESTE FICHERO PRECISA SUBRRUTINA ENV_DOI
	LDI			R19,116				; ENVIA UNA t
	LDI			R27,48				; TEXTO 0
	LDI			R16,20				; NUMERO DE CARACTERES A ESCRIBIR
	LDI			YH,HIGH(LIN_CA)		; ENVIA A NEXTION SI CAUDAL EN t0
	LDI			YL,LOW (LIN_CA)-2
	CALL		P_NEXTION_TEXTO

	RJMP		TECLADO

GRABA:
	STS			RAMP_PH, R30		; ESCRIBE EN RAM EL NUEVO VALOR PROGRAMADO DEL PH
	LDI			R17, ph_men
	MOV			R18, R30			; GRABA EL VALOR DE PH EN EEPROM EN LA POSICION 240
;	RCALL		I2CE_2404			; ESCRIBE EL NUEVO VALOR EN LA EEPRON EXTERNA
	RCALL		EEPROM_ES
	LDI			R17, PH_SB
	LDI			R18, 1
	SBRS		CONTROL_1, 1		; salta la siguiente instrucion si es UNO
	LDI			R18, 0
	RCALL		EEPROM_ES
	MOV			R16, VAL_LED
	ANDI		R16, 0B10111111		; APAGA LED PANTALLA
	MOV			VAL_LED, R16
	RCALL		LEDPANT				; ACTUALIZAR LOS LED DE LA PANTALLA	
	RCALL		NO_TECLA
	RET

TECLA: 

		; ACTUALIZAR LOS LED DE LA PANTALLA	
	LDS			R30, RAMP_PH		; CARGA EL VALOR DEL PH EN R30 DE LA MEMORIA RAM
	CLR				R7				; PONE A CERO EL RETARDO SALIDA TECLADO
TECLA1V:
	CPI			r22, RETARDO1
	BRLO		TECLA1V	
	LDS			R30, RAMP_PH		; CARGA DESDE LA RAM EL PH PROGRAMADO
	LDI			R22,00
; PROGRAMACION DE PARAMETROS PH

TECLA1:								; AJUSTAR PH VALOR EN R30

	WDR
	SBRS		CONTROL, 4			; COMPRUEBA QUE TIENE SONDA DE PH
	JMP 		TECLA5V				; SI NO TIENE SONDA DE PH VA A PROGRAMAR LOS CICLOS
	MOV			R24, TEMP_TEC
	CPI			R24, retardo_programacion	; PARA COMPARARLO CON EL RETARDO 20 SEGUNDOS SIN PULSAR TECLA
	BRPL		GRABA				; Y SALIR DE PROGRAMACION DE PARAMETROS
	LDI			R28,20				; CARGA EL RETARDO
	RCALL		RETARDO				; PARA IR A LA RUTINA DE RETARDO
	RCALL		LEC_TEC
	CPI			R17, 0B11111111		; COMPRUEBA SI SE A PULSADO ALGUNA TECLA
	BREQ		TECLA1A				; SI SE HA PULSADO SALTA A TECLA1A
	CLR				R7				; PONE A CERO EL RETARDO SALIDA TECLADO
TECLA1A:

			
			; OPCION SALTAR PARA AJUSTE DE REDOX
	CPI			R17, 0B11111011		; TECLA 2
	BREQ		TECLA2S				; SALTA PARA AJUSTAR EL REDOX
			; OPCION SALIR DE LECTURA DE TECLADO 
	CPI			R17, 0B01111111		; TECLA 5
	BRNE		TECLA1B				; SI NO ES 80 SALTA A TECLA1D
	RJMP		GRABA				; TERMINA Y SALE PARA GRABAR
TECLA1B:	; OPCION AUMENTAR PH
	CPI			R17, 0B11101111		; TECLA 2
	BRNE		TECLA1C				; SI NO ESTA PULSADA SALTA PARA VERIFICAR OTRA TECLA
	CLR				R7				; PONE A CERO EL RETARDO SALIDA TECLADO
	INC			R30					; INCREMENTA EL VALOR
	LDI			R22, 0				; CARGA EL RETARDO DE LECTURA DEL TECLADO
	CPI			R30, PH_MAX			; VERIFICA SI ESTA EN EL VALOR MAXIMO
	BRLT		TECLA1C				; SI NO SUPERA EL VALOR MAXIMO SALTA
	LDI			R30, PH_MAX			; SI SUPERA EL MAXIMO LO PONE AL MAXIMO
TECLA1C:	; OPCION DISMINUIR PH
	CPI			R17, 0B11111101		; TECLA MENOS
	BRNE		TECLA1C_A				; SI NO ESTA PULSADA SALTA
	CLR				R7				; PONE A CERO EL RETARDO SALIDA TECLADO
	DEC			R30					; DISMINUYE EL VALOR
	LDI			R22, 0				; CARGA EL RETARDO DE LECTURA DEL TECLADO
	CPI			R30, PH_MIN			; COMPRUEBA SI SE ELCANZA EL VALOR MINIMO
	BRBC		0,	TECLA1D			; SI ES MAYOR  SALTA A TECLA1D
	LDI			R30, PH_MIN			; SI SE ALCANZA PONE EL VALOR MINIMO
TECLA1C_A:	; PARA UTILIZAR ACIDO DISMINUIR PH OPCION INICIAL
	CPI			R17, 0B11110100		; TECLA CALIBRAR MENOS Y PROGRAMAR
	BRNE		TECLA1C_B			; SI NO ESTA PULSADA SALTA
	CLR				R7				; PONE A CERO EL RETARDO SALIDA TECLADO
	CLT								; PONE A CERO EL BIT T DE SREG
	BLD			CONTROL_1, 1		; PASA LA OPCION AL REGISTRO DE CONTROL 

TECLA1C_B:	; PARA UTILIZAR SOSA ELEVAR PH
	CPI			R17, 0B11100110		; TECLA CALIBRAR MAS Y PROGRAMAR
	BRNE		TECLA1D				; SI NO ESTA PULSADA SALTA
	CLR				R7				; PONE A CERO EL RETARDO SALIDA TECLADO
	SET								; PONE A UNO EL BIT T DE SREG
	BLD			CONTROL_1, 1		; PASA LA OPCION AL REGISTRO DE CONTROL

TECLA1D:	; PONER EL VALOR EN PANTALLA DEL PH
LDI			R22,00
LDI			R18,32
STS			$96B,R18			; APAGA EL VALOR EN PANTALLA
STS			$96D,R18			
CALL		PRO_TECLA
TECLA1D_1:
	CPI			R22,RETARDO3
	BRLO		TECLA1D_1
	LDI			R16,01				; CODIGO FLECHA ABAJO
	SBIC		PINB,7				; PUENTE SUBIR PH
	LDI			R16,02				; CODIGO FLECHA ARRIBA
	STS			$96F,R16			; PONE LA FLECHA PARA ARRIBA O PARA ABAJO
	MOV			R24, R30			; PONE EL VALOR EN R24 PARA CONVERTIRLO EN DECIMAL
	RCALL		RADC   				; CONVERTIR UN NUMERO EN DIGITOS DATO EN R24
	STS			$96B, R2			; PONE EL RESULTADO EN PANTALLA DECENAS DE PH
	LDI			R16, 46				; pone un punto
	STS			$096C, R16
	STS			$096D, R3			; PONE EL RESULTADO EN PANTALLA UNIDADES DE PH
	CALL		PRO_TECLA
TECLA1E:
	CPI			R22, RETARDO2		; VALOR DEL TIEMPO DE RATARDO LECTURA DEL TECLADO
	BRLO		TECLA1E				; COMPRUEBA EL TIEMPO DE RETARDO 
	RJMP		TECLA1	


TECLA2S:  ;GRABA EL VALOR DEL PH Y LEE EL DE REDOX
	STS			RAMP_PH, R30		; ACTUALIZA EN RAM EL NUEVO VALOR PROGRAMADO DEL PH
	LDI			R17, PH_MEN
	MOV			R18, R30			; GRABA EL VALOR DE PH EN EEPROM EN LA POSICION 240
;	RCALL		I2CE_2404			; ESCRIBE EL NUEVO VALOR EN LA EEPRON EXTERNA
	RCALL		EEPROM_ES
	RCALL		NO_TECLA
	SBRC		CONTROL, 7			; COMPRUEBA QUE TIENE SONDA DE CL
	RJMP		TECLA3V				; PROGRAMACION DE CLORO
	SBRC		CONTROL, 6			; COMPRUEBA QUE TIENE SONDA DE REDOX
	RJMP 		TECLA2V				; PROGRAMACION DE REDOX
	JMP			TECLA5V				; PARA PROGRAMAR LOS CICLOS



LEC_TEC: 	;RUTINA LECTURA DEL TECLADO
	CLR			R16
	OUT			DDRA, R16			; PUERTO A COMO ENTRADA
	OUT			PORTA, R16			; CON VALOR 1 EN TODAS LAS SALIDAS
	CBI			PORTC, TEC			; pone a 0 el bit de PARA ACTIVAR EL TECLADO
	NOP
	IN			R17, PINA			; lee el valor del puerto a y lo almacena en r17
	SER			R16					; PONE R16 TODO A 1
	SBI			PORTC, TEC			; pone a 1 el bit PARA DESACTIVAR TECLADO
	OUT			DDRA, R16			; PUERTO A COMO SALIDA
;MOV R18,R17
;LDI			R17,203
;CALL		EEPROM_ES			; ACTUALIZA EL VALOR EN LA POSICION 200 DE LA EEPROM
;MOV R17,R18
;SBRS		R17,5				; ES LA TECLA DE CAUDAL SI ES UNO VA A RET
	WDR
	RET



RELE_PH:		;PARA ENCENDER RELE PH 15 SEGUNDOS
	LDI			LEC_REL, 0
	CALL		PRO2H 				; ENCIENDE BOMBA DE PH Y LED
	SBI			PORTB, 1			; ENCIENDE BOMBA DE APOYA DE CLORO
;	SBI			PORTB, 6
;	SBI			PORTB, 7
	CALL		LEDPANT
RELE_PH_1:
	CPI			LEC_REL, 15
	BRLO		RELE_PH_1
	CALL		PRO2F1	 			; APAGA BOMBA DE PH Y LED
	CBI			PORTB, 1			; APAGA BOMBA DE APOYO DE CLORO
;	CBI			PORTB, 6
;	CBI			PORTB, 7

	RET
;       20x4        16x4   tipo de display
; linea 1-128 		128 
; linea 2-192		192
; linea 3-148		144
; linea 4-212		208

PRO_TECLA:
; ************************* OJO PARA EVITAR QUE SALGA DE PROGRAMACION DE VALORES
;LDI			R16, 00				; SI ES ASI....
;MOV			TEMP_TEC, R16		; PONE EL CONTADOR DE RETARDO A CERO


					; PROGRAMACION DE PRODUCION	

	LDI				R16, 128		; 11000000 escribir en linea 2 linea (192)
	RCALL			ENVINT
	LDI				YH,HIGH (AJ_PRO); POSICION ALTA DEL TAXTO EN RAM 080
	LDI				YL,LOW  (AJ_PRO); direccion BAJA DEL TEXTO EN RAM      	
  	LDI				R17,20 			; bytes a enviar 
	RCALL			ENVIARTEXTO		; RUTINA PARA ENVIAR TEXTO E PANTALLA
	LDI				R16,48			; ENVIA UN 0
	LDI				YH,HIGH (AJ_PRO); POSICION ALTA DEL TAXTO EN RAM 080
	LDI				YL,LOW  (AJ_PRO); direccion BAJA DEL TEXTO EN RAM      	
;	CALL			P_NEXTION_TEXTO


					; PROGRAMACION DE PH

	LDI				R16, 192		; 11000000 escribir en linea 2 linea (192)
	RCALL			ENVINT
	LDI				YH,HIGH (AJ_PH); POSICION ALTA DEL TAXTO EN RAM 080
	LDI				YL,LOW  (AJ_PH); direccion BAJA DEL TEXTO EN RAM      	
  	LDI				R17,20 			; bytes a enviar 
	RCALL			ENVIARTEXTO		; RUTINA PARA ENVIAR TEXTO E PANTALLA
	SBRC			CONTROL, 7		; COMPRUEBA QUE TIENE SONDA DE CL
	RJMP			PRO_TECLA_1		; PROGRAMACION DE CLORO
	LDI				R16,49			; ENVIA UN 1
	LDI				YH,HIGH (AJ_PH); POSICION ALTA DEL TAXTO EN RAM 080
	LDI				YL,LOW  (AJ_PH); direccion BAJA DEL TEXTO EN RAM    
;	CALL			P_NEXTION_TEXTO
					; PROGRAMACION DE REDOX

	LDI				R16, 148		; ESCRIBIR LINEA 3
	RCALL			ENVINT
	LDI				YH,HIGH (AJ_RD); POSICION ALTA DEL TAXTO EN RAM 080
	LDI				YL,LOW  (AJ_RD); direccion BAJA DEL TEXTO EN RAM      	
  	LDI				R17,20 			; bytes a enviar 
	RCALL			ENVIARTEXTO		; RUTINA PARA ENVIAR TEXTO E PANTALLA
	LDI				R16,50			; ENVIA UN 2
	LDI				YH,HIGH (AJ_RD); POSICION ALTA DEL TAXTO EN RAM 080
	LDI				YL,LOW  (AJ_RD); direccion BAJA DEL TEXTO EN RAM   
;	CALL			P_NEXTION_TEXTO
	RJMP			PRO_TECLA_2
PRO_TECLA_1:		; PROGRAMACION DE CLORO
	LDI				R16, 148		; 11000000 escribir en linea 2 linea (192)
	RCALL			ENVINT
	LDI				YH,HIGH (AJ_CL); POSICION ALTA DEL TAXTO EN RAM 080
	LDI				YL,LOW  (AJ_CL); direccion BAJA DEL TEXTO EN RAM      	
  	LDI				R17,20 			; bytes a enviar 
	RCALL			ENVIARTEXTO		; RUTINA PARA ENVIAR TEXTO E PANTALLA
PRO_TECLA_2:		; PROGRAMACION DE CICLOS
	LDI				R16, 212		; 11000000 escribir en linea 2 linea (192)
	RCALL			ENVINT
	LDI				YH,HIGH (AJ_POL); POSICION ALTA DEL TAXTO EN RAM 080
	LDI				YL,LOW  (AJ_POL); direccion BAJA DEL TEXTO EN RAM      	
  	LDI				R17,20 			; bytes a enviar 
	RCALL			ENVIARTEXTO		; RUTINA PARA ENVIAR TEXTO E PANTALLA
	LDI				R16,51
	LDI				YH,HIGH (AJ_POL); POSICION ALTA DEL TAXTO EN RAM 080
	LDI				YL,LOW  (AJ_POL); direccion BAJA DEL TEXTO EN RAM  
;	CALL			P_NEXTION_TEXTO	   
	; ENVIAR A LA UART UN RETORNO DE CARRO

	RET

; RURINA GESTION NEXTION PAGINA A ENVIAR Y RUTINA PROGRAMACION O CALIBRACION

						
LEC_TECB:		; PANTALLA INFORMACION



;COMPROBACION NUEVO DATO
LDS			R18,RG_232				; CARGA EL PRIMER DATO RECIBIDO DEL PUERTO SERIE
CPI			R18,0XFF				; SI ES FF ES QUE NO HAY DATO NUEVO
BRNE		LEC_TECB1				; ESTA LINEA LA SALTA SI NO HAY DATO NUEVO
RET									; RETORNA


LEC_TECB1:

WDR
LDS			R18,RG_232+1			; LEE EL SEGUNDO DATO ENVIADO POR NEXTION PULSADOR INFORMACION
CPI			R18,1					; SI  SE HA PULSADO VA A PANTALLA DE INFORMACION NEXTION
BRNE		LEC_TECB_A				; SI NO ES 1 VA A COMPROBAR SIGUIENTE PANTALLA
LDI			R31,30					; CARGA EL RETARDO DE 10 SEGUNDOS PARA SALIR DE LA PANTALLA INFORMACION
CALL		INI_NEXTION_I			; VA A PANTALLA INFORMACION NEXTION
RJMP		LEC_TECB_F				; TERMINA Y RESTAURA LOS VALORES A FF

LEC_TECB_A:		; PANTALLA PARAMETROS
CPI			R18,2
BRNE		LEC_TECB_C
LDI			R31,30
CALL		INI_NEXTION_PA
RJMP		LEC_TECB_F				; TERMINA Y RESTAURA LOS VALORES A FF


LEC_TECB_C:		; PANTALLA PROGRAMACION
CPI			R18,3
BRNE		LEC_TECB_D
LDI			R31,30
CALL		INI_NEXTION_CA
CLR			R18
STS			RG_232+1,R18
RJMP		LEC_TECB_F				; TERMINA Y RESTAURA LOS VALORES A FF

LEC_TECB_D:		; PANTALLA ERROR DE AQUI NO SALE
CPI			R18,4
BRNE		LEC_TECB_E						;  VA A RUTINA VER ERROR
JMP			VER_ERROR

LEC_TECB_E:		; PANTALLA INFORMACION DE DATOS DEL EQUIPO
CPI			R18,9
BRNE		LEC_TECB_F		
LDI			R16,57
STS			0xA01,R16
CALL		P_NEXTION_PAGE
RET



LEC_TECB_F:		; COMPRUEBA SELÑAL DE WIFI
LDS			R18,RG_232

;		LDI			R17,205
;		CALL		EEPROM_ES				; ACTUALIZA EL VALOR EN LA POSICION 201 DE LA EEPROM
CPI			R18,113							; CODIGO DE LA ALMOHADILLA ENVIADA POR WIFI
BRNE		LEC_TECB_G
CALL		N_PRO_PAR						; PROGRAMACION DE PARAMETROS DE LA WIFI

LEC_TECB_G:
RET
SER			R16
STS			RG_232,R16
;STS			RG_232+1,R16
STS			RG_232+2,R16
RET









