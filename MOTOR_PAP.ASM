; CONTROL MOTOR PASO A PASO

; SE USA EL PUERTO C SALIDAS 39 40 41 42 QUE SON RESPECTIVAMENTE C4,C5,C6,C7
; PARA EL CONTROL DE LA VELOCIDAD SE USA ADC2 PATA 59


  
; SECUENCIA DE GIRO
MOTOR_PAP:
	LDI				R19,0b00010000
	OUT				PORTC,R19
	CALL			VELOCIDAD
;	CALL			VELOCIDAD
	LDI				R19,0b00100000
	OUT				PORTC,R19
	CALL			VELOCIDAD
;	CALL			VELOCIDAD
	LDI				R19,0b01000000
	OUT				PORTC,R19
	CALL			VELOCIDAD
;	CALL			VELOCIDAD
	LDI				R19,0b10000000
	OUT				PORTC,R19
	CALL			VELOCIDAD
;	CALL			VELOCIDAD
RET
;	RJMP			MOTOR_PAP

; MEDICION DE LA VELOCIDAD
VELOCIDAD:

	CLR				R24
 	LDI				R18,3				; LINEA DE ENTRADA EN EL CONVERTIDOS PCF8591
;	LDI				R26, 10				; NUMERO DE LECTURAS Ó CALIBRACION
; CONFIGURAR TENSION DE REFERENCIA A VDD, FORMA DE ALMACENAMIENTO CON EL REGISTRO ADLAR A 1 Y CANAL A LEER
;	LD1				R16, (0<<REFS1)|(1<<REFS0)|(0<<ADLAR) LEER LINEA ADC0 ES LA PATA 40
	LDI				R16,0B11100000		; SEÑAL INTERNA DE REFERENCIA A  VDC BIT 7Y6 
										; BIT DE ADLAR A 1 
	ADD				R16,R18				; EN R18 EL CANAL A LEER Y GANANCIA VER PAG 245
	OUT				ADMUX,R16
	LDI				R16,0B11010111		; PREESCALA A 128 "8.000.000/128=62.500Hz
	OUT				ADCSRA,R16
ADC_P2A:
	IN				R16,ADCSRA
	NOP
	BST				R16,6				; CARGA EN EL REGISTRO T DE SREG EL 6 ACSRA
	BRTS			ADC_P2A				; SALTA A ADC_P1 SI EL REGISTRO ES UNO SE PONE A CERO AL TERMINAR LA CONVERSION
	IN	 			R24,ADCH			; CARGA EL RESULTADO EN R17
	LSR				R24
LDI				R19,40				; PARAMETRO PARA LIMITAR LA VELOCIDAD MAXIMA
ADD				R24,R19
LDI				R25,50
SERVO_1:
WDR
NOP
DEC				R25
BRNE			SERVO_1
LDI				R25,250
DEC				R24
BRNE			SERVO_1
	RET
