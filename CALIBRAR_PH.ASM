;  RUTINA CALIBRAR PARAMETROS PRODUCCION PH REDOX Y CLORO LIBRE
; EN ESTA RUTINA ESTA EL CONTROL DE LA PANTALLA
; LINEA DE CONTROL "CONTROL.4!
PRO7:	; CALIBRAR EL PH
	SBRS			CONTROL,4			; SALTA LA PROXIMA INSTRUCION SI ES UNO,
	JMP				PRO6				; VA A CALIBRAR SAL OTRA VEZ
	LDS				R30, RAMC_PH		; VALOR PARA EL CALIBRADO DE LA CONCENTRACION DE SAL
	LDI				R22, 00
	CLR				R7					; PONE A CERO EL RETARDO SALIDA TECLADO
PRO7A:
	LDI				R22,00
	LDI				R18,32				; APAGA EL DIGITO SAL
	STS				$918,R18
	STS				$919,R18			; PONE EN PANTALLA EL VALOR CALIBRADO DE LA SAL UNIDADES
	STS				$91B,R18			; PONE EN PANTALLA EL VALOR CALIBRADO DE LA SAL DECIMAS
	RCALL			CAL_TECLA
PRO7B:			; TIEMPO DIGITO APAGADO
	CPI				R22,RETARDO3		; VALOR DEL TIEMPO DE RATARDO LECTURA DEL TECLADO
	BRLO			PRO7B				; COMPRUEBA EL TIEMPO DE RETARDO 
	CALL			LEDPANT
	WDR
	; VALOR DE MEDICION TOTAL PH	
	LDI				R18, P_PH			; LINEA DE ENTRADA EN EL CONVERTIDOR PCF8591
	LDI				R26, 231			; NUMERO DE LECTURAS Ó CALIBRACION
	CALL			ADC_P
			; RESTA EL ERROR INICIAL DE LA MEDICION



	LDI				R16, 216			; RESTA 10 PARA LUEGO SUMARLE LA CALIBRACION ENTRE 0 Y 20
	SUB				R16, R24			; Y RESTANDOLO DEL LEIDO			
	MOV				R19, R30			; LEE EL VALOR DE CALIBRACION que suele ser 10
	ADD				R16, R19			; SE LA SUMA AL LEIDO
	MOV				R24, R16
	STS				RAM_PH, R24			; ALMACENA LA MEDICION EN LA MEMORIA RAM
	CALL			RADC
LDI R18,46		; PONE UN PUNTO 7.4
STS $91A,R18
	STS				$918,R1
	STS				$919,R2				; PONE EN PANTALLA EL VALOR CALIBRADO DE LA SAL UNIDADES
	STS				$91B,R3				; PONE EN PANTALLA EL VALOR CALIBRADO DE LA SAL DECIMAS
	RCALL			CAL_TECLA
PRO7C:
	CPI				R22,RETARDO2				; VALOR DEL TIEMPO DE RATARDO LECTURA DEL TECLADO
	BRLO			PRO7B				; COMPRUEBA EL TIEMPO DE RETARDO 
; TECLA 0 PROGRAMAR
; TECLA 1 MENOS
; TECLA 2 FLECHA
; TECLA 3 CALIBRAR
; TECLA 4 MAS
; TECLA 5 
; TECLA 6 NIVEL ACIDO
; TECLA 7 SALIR
	; VALOR DE MEDICION 	
	WDR
	LDI				R22,00				; reatardo lectura de las valores 
	RCALL			LEC_TEC
	CPI				R17, 0B11111101		; TECLA - BAJA EL VALOR
	BREQ			BAJAR_PH
	CPI				R17, 0B11101111		; TECLA + INCREMENTA EL VALOR
	BREQ			SUBIR_PH
	CPI				R17, 0B01111111		; TECLA 7 SALIR VA A CALIBRACION REDOX
	BREQ			SALIR_PH1
	CPI				R17, 0B11111011		; TECLA FLECHA GRABA Y VA A CALIBAR EDOX
	BREQ			SALIR_PH
	MOV				R24, TEMP_TEC
	CPI				R24, 50				; PARA COMPARARLO CON EL RETARDO SIN PULSAR TECLA
	BRPL			SALIR_PH1			; Y SALIR DE PROGRAMACION DE PARAMETROS

	CPI				R17, 0B11100111		; PONER EL VALOR POR DEFECTO DEL PH 140
	BREQ			CALI_PH


	RJMP			PRO7A
BAJAR_PH:
	CLR				R7					; PONE A CERO EL RETARDO SALIDA TECLADO
	DEC				R30
	LDI				R22,00
	CPI				R30, 2
	BRBC			0, BAJAR_PH1 
	LDI				R30, 2
	RJMP			PRO7A
BAJAR_PH1:
	RJMP			PRO7A
SUBIR_PH:
	CLR				R7					; PONE A CERO EL RETARDO SALIDA TECLADO
	INC				R30
	LDI				R22,00
	CPI				R30, 22				; MINUTOS POR CICLO ( INVIERTE)
	BRBS			0, SUBIR_PH1		; SI MAYOR SALTA A SUBIR_PH1 Y PONE R31 CON EL VALOR MAZIMO
	LDI				R30,22
SUBIR_PH1:
	RJMP			PRO7A
CALI_PH:
	LDI				R30,10				; VALOR DE FABRICA PARA CALIBRAR PH
	STS				RAMC_PH, R30		; VALOR PARA EL CALIBRADO DE LA CONCENTRACION DE SAL
	LDI				R17, PHC_MEN		; POSICION DE MEMORIA A ESCRIBIR EN EEPROM $005
	MOV				R18, R30 
	RCALL			EEPROM_ES	
	RCALL			NO_TECLA
	RJMP			PRO7A
SALIR_PH:  ; GRABA LOS NUEVOS VALORES Y VA A CALIBRAR REDOX
	STS				RAMC_PH, R30		; VALOR PARA EL CALIBRADO DE LA CONCENTRACION DE SAL
	LDI				R17, PHC_MEN		; POSICION DE MEMORIA A ESCRIBIR EN EEPROM $005
	MOV				R18, R30 
	RCALL			EEPROM_ES			; GRABA EN EEPROM EL VALOR DE LA NUEVA CALIBRACCION
	RCALL			LEDPANT				; ACTUALIZAR LOS LED DE LA PANTALLA	
	RCALL			NO_TECLA			; PARA ESPERAR A QUE SE SUELTE LA TECLA SALIR
	JMP				PRO8
SALIR_PH1:  ; GRABA LOS VALORES Y TERMINA
	STS				RAMC_PH, R30		; VALOR PARA EL CALIBRADO DEL PH
	LDI				R17, PHC_MEN		; POSICION DE MEMORIA A ESCRIBIR EN EEPROM $005
	MOV				R18, R30 
	RCALL			EEPROM_ES			; GRABA EN EEPROM EL VALOR DE LA NUEVA CALIBRACCION
	MOV				R16, VAL_LED		;APAGA LUZ PANTALLA
	ANDI			R16, 0B10111111
	MOV				VAL_LED, R16
	RCALL			LEDPANT				; ACTUALIZAR LOS LED DE LA PANTALLA	
	RCALL			NO_TECLA
	RET

