
; CALIBRACION

; CON PUENTE EN LA CLEMA AJUSTAR LA SILIDA A 80Mv MEDICION DE CLORO 00 SEÑAL MINIMA PARA ACTIVAR EL MODULO
; CON 1.30 Mv MARAC 1 PPM DE CLORO
; CON 1.80 Mv MARCA 2 PPM DE CLORO
; CON 2.5  Mv MARCA EL MAXIMO 3.3 PPM SI SUPERA ESTA TENSION DE 2.5 NO MARCA MAS CLORO DA 3.3


;		RUTINA MED_CL
PRO41:
	RET
PRO4:	; PARA MEDIR EL CLORO
;	LDS  			R19, minu			; CARGA LOS MINUTOS 
;	CPI				R19, 00				; PARA NO ENCENDER EL PRIMER MINUTO
;	BRBS			0, PRO41
	WDR
	; VALOR DE MEDICION TOTAL	
	LDI				R18, P_CL				; LINEA DE ENTRADA EN EL CONVERTIDOS PCF8591
	LDS				R26, RAMC_CL		; NUMERO DE LECTURAS Ó CALIBRACION 1D8 SON 200 MEDICIONES
;	CALL			PCF
	CALL			ADC_P	
	LSR				R24					; DIVIDIMOS ENTRE DOS
	LSR				R24					; DIVIDIMOS ENTRE DOS TOTAL 4
	MOV				R16, R24


PRO4A:
	LDI				R24, 10				; VALOR DE CLORO MINIMO PARA ACTIVAR LA OPCION AUTOMATICO CORRESPONDE A 0,2 DE CLORO
	CP				R24, R16
	BRLT			PRO4D				; SI ES MAYOR EL VOLOR MEDIDO VA A PRO4D
	CBR			CONTROL, 0B10000000		; LINEA DE CONTROL PARA LA FUENTE EN RUTINA RELOJ MODO "AUTO" SI EL VALOR MEDIDO
										; ES SUPERIOR A 0,3 SE ACTIVA SI NO SE DESACTIVA		
	RET									; RETORNA POR NO HABER DETECTADO SEÑAL MINIMA DE SONDA 0,3 PPM

PRO4D: ;Grabar el valor en RAM Ó NO

	SUBI			R16, 15
	SBR			CONTROL, 0B10000000		; LINEA DE CONTROL PARA LA FUENTE EN RUTINA RELOJ SE ACTIVA
	LDS				R24, RAM_CL			; LEE EL VOLOR GRABADO EN RAM
CALL RADC		; PRESENTA EN PANTALLA
STS				$9CD, R1
STS				$9CE, R2
LDI				R19,46				; PONE EL PUNTO
STS				$9CF,R19
STS				$9D0, R3
; PRESENTA EN CALIBRAR Y QUITA LA OPCION N/D
STS				$941, R2
LDI				R19,46				; PONE EL PUNTO
STS				$942,R19
STS				$943, R3

	INC				R24					; INCREMENTO EN UNA UNIDAD Y 
	CP				R16, R24			; LO COMPARA CON EL VALOR ULTIMO LEIDO
	BRLT			PRO4D1				; SI NO ES MAYOR DE DOS DECIMAS NO LO ALMACENA
	STS				RAM_CL, R24			; ALMACENA LA MEDICION EN LA MEMORIA RAM 206
	RJMP			PRO4D2
PRO4D1:
	DEC				R24					; RESTA UNA UNIDAD AL VALOR LEIDO
	DEC				R24					; RESTA UNA UNIDAD AL VALOR LEIDO
	CP				R24,R16				; Y LO VUELVE A COMPARAR CON EL ALMACENADO
	BRLT			PRO4D2
	STS				RAM_CL, R24			; ALMACENA LA MEDICION EN LA MEMORIA RAM
PRO4D2:
	MOV				R19, R16			; LO MUEVE A R19 PORQUE R16 SE USA EN LA RUTINA EEPROM_RW
	LDS				R18,RAMP_CL			; CONTENIDO DE CLORO PROGRAMADO 207
PRO4E: ;EN R18 VALOR PROGRAMADO; DESACTIVA LA PRODUCION DE CLORO SI EL VALOR LEIDO ES MAYOR QUE EL PROGRAMADO
	LDS				R19,RAM_CL			; R19 ES EL VALOR REAL DEL CLORO LIBRE
	CALL			AYUDA_CL
	INC				R18					; R18 ES EL VALOR PROGRAMADO
	CP				R19,R18				; SI EL CL MEDIDO ES MENOR QUE EL PROGRAMADO
	BRLO			PRO4F				; SALTA A PRO4A (OP1 > OP2 SALTA)
	CALL			APAGAR_FUENTE
	RJMP			PRO4G
PRO4F: ;ACTIVA LA PRODUCION DE CLORO SI EL VALOR LEIDO ES MENOR QUE EL PROGRAMADO
	DEC				R18
	DEC				R18
	CP				R18,R19
	BRLT			PRO4G
	CALL			ENCENDER_FUENTE
PRO4G:
	RET
