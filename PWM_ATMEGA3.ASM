; REGISTRO TCCR0
;		7		6		5		4		3		2		1		0
;		FOC0	WGM00	COM01	C0M00	WGM01	CS02	CS01	CS00


;
;	Modo de Comparación de Salida, Modo rapido PWM
;
;	WGM01		WGM00		Descripción
;		0 		0 		Modo en operación normal, OC0A desconectado.
;
;		0 		1 		PWM control
;
;		1 		0 		CTC
;
;
;		1 		1 		Fast pwm
;
;
;	Modo de Comparación de Modo fase correcta PWM
;
;		COM01 	COM00 Descripción
;		0 		0 		Modo en operación normal, OC0A desconectado.
;
;		0 		1 		Reservado
;
;		1 		0 		Pone a cero oc0
;
;		1 		1 		Pone a 1 oc0

;CS02,CS01,CS00 DIVISIR DE FRECUENCIA
; DDR 		SALIDA A UNO ENTRADA A CERO
; PORT		A UNO LA RESISTENCIA PUS-PULL ACTIVADA- EN OPCION SALIDA VALOR DE ESTA A CERO Ó A UNO
; PIN		LECTURA DEL VALOR DE ENTRADA

;	CS02 	CS01 	CS00 	Descripción
;	0 		0 		0 		Sin fuente de Reloj(Timer/Contador parados)
;	0 		0 		1 		Clk I/O (Sin prescalador)
;	0 		1 		0 		Clk I/O /8(Prescalador)    FRECUENCI /   4000
;	0 		1 		1 		Clk I/O /64(Prescalador)   FRECUENCIA / 16000
;	1 		0 		0 		Clk I/O /256(Prescalador)  FRECUENCIA / 32000
;	1 		0 		1 		Clk I/O /1024(Prescalador) FRECUENCIA / 64000
;	1 		1 		0 		Fuente de Reloj Externo pin T0. Reloj con flanco de bajada
;	1 		1 		1 		Fuente de Reloj Externo pin T0. Reloj con flanco de subida
; PIN E3 ES LA SALIDA DE IMPULSOS


DC_PWM_3:			; INICIALIZA EL RELOJ	TCCR0 VER DC_MOTOR ATMEGA 32 EN CARPETA DATA
	LDI				R16,0B00001000	; PUERTO  3 SALIDA DE FRECUENCIA IMPULSOA
	OUT   			DDRE, R16		; PUERTO 5 6 Y 7 ENTRADA DEL MESTRO
	LDI				R16,0B11111111	; RESISTENCIA CONECTADA A POSITIVO	
	OUT   			PORTE, R16		; Y PUERTO 0 TIPO DE FUENTE
	
	LDI				R19,(1<<COM3A1) | (1<<COM3A0) | (0<<COM3B1) | (0<<COM3B0) | (0<<COM3C1) | (0<<COM3C0) | (1<<WGM31) | (1<<WGM30);
	STS				TCCR3A,R19
	LDI				R19,(0<<ICNC3) | (0<<ICES3) | (1<<WGM33) | (1<<WGM32) | (0<<CS32) | (1<<CS31) | (1<<CS30);
	STS				TCCR3B,R19

	LDI				R19,0xFF
	STS				TCNT3L,R19
	LDI				R19,0xFF
	STS				TCNT3H,R19

	LDI				R16,100
	STS				OCR3AL,R16
	LDI				R16,01
	STS				OCR3AH,R16

	LDI				R16,0x5E
	STS				ICR3L,R16
	LDI				R16,04
	STS				ICR3H,R16


DC_PWM_A:
	CALL			PW_POT				; RUTINA CONTROL POR POTECIOMETRO
;	CALL			PW_PUL				; RUTINA CONTROL POR PULSADOR
	STS			OCR3AL,R24
	COM				R24
	CALL			RADC
	STS				$100,R1
	STS				$101,R2				; VALOR DE LAS DECENAS
	STS				$102,R3				; VALOR DE LAS UNIDADES
	LDI				R16,128				; ESCRIBIR LINEA 2
	CALL			ENVINT				; En subrrutina Env_doi Envia instrucion para escribir en linea 1
	LDI				YH, HIGH(LIN1)		; POSICION BIT ALTO DEL TEXTO A ENVIAR ram en 070
	LDI				YL, LOW(LIN1)		; POSICION BIT BAJO DEL TEXTO A ENVIAR
	LDI				R17,20				; NUMERO DE DIGITOS A ENVIAR A PANTALLA
	CALL			ENVIARTEXTO			; RUTINA EN ESTE FICHERO PRECISA SUBRRUTINA ENV_DOI	
	RJMP			DC_PWM_A



PW_POT:			; CONTROL DE LA VELOCIDAD POR POTENCIOMETRO RESULTADO EN R24
	CLR				R24
 	LDI				R18, 3				; LINEA DE ENTRADA EN EL CONVERTIDOS PCF8591
; CONFIGURAR TENSION DE REFERENCIA A VDD, FORMA DE ALMACENAMIENTO CON EL REGISTRO ADLAR A 1 Y CANAL A LEER
;	LD1				R16, (0<<REFS1)|(1<<REFS0)|(0<<ADLAR) LEER LINEA ADC0 ES LA PATA 40
;	LDI				R16,0B11100000		; SEÑAL INTERNA DE REFERENCIA A  VDC BIT 7Y6 A 2,5VOLTIOS
										; BIT DE ADLAR A 1 
	LDI				R16,0b01100000		; SELAL DE REFERENCIA A 5 VOLTIOS
	ADD				R16,R18				; EN R18 EL CANAL A LEER Y GANANCIA VER PAG 245
	OUT				ADMUX,R16
	LDI				R16,0B11010111		; PREESCALA A 128 "8.000.000/128=62.500Hz
	OUT				ADCSRA,R16
ADC_P2B:
	IN				R16,ADCSRA
	NOP
	BST				R16,6				; CARGA EN EL REGISTRO T DE SREG EL 6 ACSRA
	BRTS			ADC_P2B				; SALTA A ADC_P1 SI EL REGISTRO ES UNO SE PONE A CERO AL TERMINAR 
	IN	 			R24,ADCH
	RET	
	
PW_PUL:
	CLR				R16
	OUT				DDRA, R16			; PUERTO A COMO ENTRADA
	OUT				PORTA, R16			; CON VALOR 1 EN TODAS LAS SALIDAS
	CBI				PORTC, TEC			; pone a 0 el bit de PARA ACTIVAR EL TECLADO
	NOP
	IN				R17, PINA			; lee el valor del puerto a y lo almacena en r17
	SER				R16					; PONE R16 TODO A 1
	SBI				PORTC, TEC			; pone a 1 el bit PARA DESACTIVAR TECLADO
	OUT				DDRA, R16			; PUERTO A COMO SALIDA
	CPI				R17, 0B11101111		; TECLA +	
	BREQ			PWM_A
	CPI				R17, 0B11111101		; TECLA -	
	BREQ			PWM_B
	MOV				R24,R19
	RET
PWM_A:
	INC				R19
	CPI				R19,255
	BRNE			PWM_AA
	LDI				R19,254
PWM_AA:
	MOV				R24,R19	
	COM				R24
	RET

PWM_B:
	DEC				R19
	CPI				R19,00
	BRNE			PWM_BB
	LDI				R19,1
PWM_BB:
	MOV				R24,R19
	COM				R24
	RET


