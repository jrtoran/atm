; VIENE DE LA RUTINA MEDICION DE SAL
; CONTROL DE CAUDAL DA ERROR TRANSCURRIDOS 120 SEGUNDOS Y NO RETORNA
; ALMACENA LOS SEGUNDOS EN RAM POSICION
; SI LA PRODUCION ES MENOS DE 2 DURANTE 120 SEGUNDOS CORTA

CONTROL_CAUDAL:			; VIENE DE LA RUTINA MEDICION DE SL LINEA 44
	LDS				R18, RAM_CAUDAL		; LEE LOS SEGUNDOS TRANSCURRIDOS
	INC				R18
	STS				RAM_CAUDAL, R18
	CPI				R18, 120				; Y LOS COMPRARA CON 120
	BRBS			0, CONTROL_CAUDAL_2	; SI ES MENOS RETORNA

; MENSAJE DE ERROR POR FALTA DE CaUDAL
	CALL			APAGAR_FUENTE
	CBI				PORTD,b_acido		; APAGA BOMBA DE ACIDO
	LDI				R16, 128			; 11000000 escribir en linea 2 linea (192)( linea 4 seria 212)
	CALL			ENVINT				; RUTINA PARA ENVIAR A LA PANTALLA UNA INSTRUCION, " ESCRIBIR LINEA 2"
	LDI				YH, HIGH (LIN_2S)	; POSICION ALTA DEL TAXTO EN RAM 080
	LDI				YL, LOW  (LIN_2S)	; direccion BAJA DEL TEXTO EN RAM  "APAGAR EQUIPO"    	
  	LDI				R17,16   			; bytes a enviar 
	CALL			ENVIARTEXTO			; RUTINA PARA ENVIAR TEXTO E PANTALLA
	LDI				R16, 192			; 11000000 escribir en linea 2 linea (192)( linea 4 seria 212)
	CALL			ENVINT				; RUTINA PARA ENVIAR A LA PANTALLA UNA INSTRUCION, " ESCRIBIR LINEA 2"
	LDI				YH, HIGH (F_PRO)	; POSICION ALTA DEL TAXTO EN RAM 080
	LDI				YL, LOW  (F_PRO)	; direccion BAJA DEL TEXTO EN RAM  "FALLO PRODUCCION"    	
  	LDI				R17,16   			; bytes a enviar 
	CALL			ENVIARTEXTO			; RUTINA PARA 
CONTROL_CAUDAL_1:						; DETIENE EL PROGRAMA
	NOP
	NOP
	SLEEP
	RJMP			CONTROL_CAUDAL_1	; SE DETIENE EL EQUIPO

CONTROL_CAUDAL_2:	; RETORNO A PRO3D NO A LLEGADO A 120 SIGUE FUNCIONANDO
	JMP				PRO3D				

TEXTO_ERRORES:
;cargamos TEXTO NUEVO DE ERRORES   viene de ini_atmega16
    LDI   			YH,0x03        	; direcion alta donde se pone el texto en RAM
    LDI   			YL,0x30      	; direccion baja donde se pone el texto en RAM 
    LDI   			ZH,high(TEXTO2*2); direccion alta del TEXTO en Flash
    LDI   			ZL,low(TEXTO2*2) ; direccion baja del TEXTO en Flash 
    LDI   			R16,160      	; longitud de texto a copiar en RAM
;*** RURINA CARGAR TEXTO DE FLASH A RAM  
;EN Y (YH,YL) POSICION EN RAM
;EN Z (ZH,ZL) POSICION EN FLASH
;EN R16 NUMERO DE LETRAS (BYTS)

CARGATEXTO_A:
	LPM      						; leemos TEXTO de FLASH y lo almacena en R0
	ADIW  			ZL,1   			; apuntamos al siguiente elemento 
	ST    			Y, R0			; guardamos en RAM POSICION Y EL CONTENIDO DE R0
	ADIW  			YL,1      		
	DEC   			R16      		; Hemos terminado..?? 
	BRNE  			CARGATEXTO_A  	; NO...seguimos cargando
	RET 
