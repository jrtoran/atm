; PROGRAMACION DE CICLOS 1-2-3-4




; GRABA EL NUMERO DE CICLOS Y SALE DE PROGRAMACION
TECLA5T:
	STS			RAM_CICLOS,R30		; ACTUALIZA EN RAM EL NUEVO VALOR PROGRAMADO DE LA PRODUCION
	LDI			R17,CICLOS_MINUTO
	MOV			R18,R30				; GRABA EL VALOR DEL REDOX EN EEPROM POSICION 241
	CALL		EEPROM_ES
	MOV			R16,VAL_LED
	ANDI		R16,0B10111111
	MOV			VAL_LED, R16
	CALL		LEDPANT				; ACTUALIZAR LOS LED DE LA PANTALLA	
	CALL		NO_TECLA
	RET

BORRAR_EEPROM:	;HORAS TOTALES DEL ELECTRODO INCREMENTA EN 1 POSICION 4B DE EEPRON NUMERO DE VECES QUE SE BORRA
	CLR			R18
	LDI			R17,N_HORAS			; BORRA LAS HORAS DE USO DE LA REJILLA
	CALL		EEPROM_ES
	LDI			R17,N_HORAS_1
	CALL		EEPROM_ES
		; INCREMENTA EL NUMERO DE VECES QUE SE BORRA POSICION 04B
	LDI			R17,N_BORRADO
	CALL		EEPROM_RW
	INC			R18
	CALL		EEPROM_ES
	CALL		NO_TECLA
	RET

TECLA5U:  ; GRABA EL  NUMERO DE CICLOS Y VA A apoyo rd/cl
	STS			RAM_CICLOS, R30		; ACTUALIZA EN RAM EL NUEVO VALOR PROGRAMADO DE LA PRODUCION
	LDI			R17,CICLOS_MINUTO
	MOV			R18,R30				; GRABA EL VALOR DEL REDOX EN EEPROM POSICION 241
	CALL		EEPROM_ES
	LDI			R16,00				; PONE EL RETARDO DEL TECLADO A 0
	MOV			TEMP_TEC,R16
	CALL		NO_TECLA
	JMP			TECLA4V				; VA A LA OPCION PARA PROGRAMAR PRODUCCION

TECLA5V:
	CLT								; PONE A 1 EL REGISTRO T DE SREG
	BLD			CONTROL_1, 5		; LINEA DE CONTROL 
	CPI			r22, RETARDO1
	BRLO		TECLA5V	
	LDI			R22,00
	LDI			R17,CICLOS_MINUTO
	CALL		EEPROM_RW
MOV	R30,R18

	CPI			R18,1
	BRNE		TECLA5
	SET								; PONE A 1 EL REGISTRO T DE SREG
	BLD			CONTROL_1,5			; LINEA DE CONTROL 

TECLA5:								; AJUSTAR EL VALOR DEL TANTO POR CIENTO DE LA PRODUCION VALOR EN R30
	WDR
	MOV			R24,TEMP_TEC
	CPI			R24,retardo_programacion	; PARA COMPARARLO CON EL RETARDO 20 SEGUNDOS SIN PULSAR TECLA
	BRPL		TECLA5T						; Y SALIR DE PROGRAMACION DE PARAMETROS					
	CALL		LEC_TEC
	CPI			R17,0B11111111		; COMPRUEBA SI SE A PULSADO ALGUNA TECLA
	BREQ		TECLA5A				; SI SE HA PULSADO SALTA A TECLA2A
	LDI			R16,00				; SI ES ASI....
	MOV			TEMP_TEC,R16		; PONE EL CONTADOR DE RETARDO A CERO
TECLA5A:
;       20x4        16x4   tipo de display
; linea 1-128 		128 
; linea 2-192		192
; linea 3-148		144
; linea 4-212		208

			; OPCION BORRA REGISTRO DE HORAS
	CPI			R17,0B11101100		; PROGRAMAR, MAS Y MENOS
	BREQ		BORRAR_EEPROM
			; OPCION PRESENTAR DESGASTE ELECTRODO
	CPI			R17,0B11110011		; CALIBRAR Y FLECHA
	BREQ		TECLA5H
			; OPCION SALTAR PARA AJUSTE DE PRODUCCION
	CPI			R17,0B11111011		; TECLA 2
	BREQ		TECLA5U				; SALTA PARA AJUSTAR LA PRODUCCION
			; OPCION SALIR DE LECTURA DE TECLADO 
	CPI			R17,0B01111111		;TECLA 5
	BRNE		TECLA5B				; SI NO ES 80 SALTA A TECLA1D
	RJMP		TECLA5T				; TERMINA Y SALE PARA GRABAR
TECLA5B:	; OPCION AUMENTAR
	CPI			R17,0B11101111		; IDEM
	BRNE		TECLA5C				; SI NO ESTA PULSADA SALTA PARA VERIFICAR OTRA TECLA
	LDI			R16, 00				; PONE EL RETARDO DEL TECLADO A 0
	MOV			TEMP_TEC,R16
	INC			R30					; INCREMENTA EL VALOR
	CPI			R30,4				; VERIFICA SI ESTA EN EL VALOR MAXIMO
	BRLT		TECLA5C				; SI NO SUPERA EL VALOR MAXIMO SALTA
	LDI			R30,4				; SI SUPERA EL MAXIMO LO PONE AL MAXIMO
TECLA5C:	; OPCION DISMINUIR CICLOS
	CPI			R17,0B11111101		; IDEM
	BRNE		TECLA5C1				; SI NO ESTA PULSADA SALTA
	LDI			R16,00				; PONE EL RETARDO DEL TECLADO A 0
	MOV			TEMP_TEC, R16
	DEC			R30					; DISMINUYE EL VALOR
	CPI			R30,1				; COMPRUEBA SI SE ELCANZA EL VALOR MINIMO
	BRBC 		0, TECLA5C1			; SI NO SE ALCANZA SALTA
	LDI			R30,1				; SI SE ALCANZA PONE EL VALOR MINIMO
TECLA5C1:	; OPCION 240 SEGUNDOS DE RETARDO
	CPI			R17,0B11110101		; TECLA CALIBRAR Y MENOS
	BRNE		TECLA5C2			; SI NO ESTA PULSADA SALTA
	LDI			R17,retardo_inicio
	LDI			R18,0
	CALL		EEPROM_ES
LDI R18,32
STS	$9A9,R18
	CLT								; PONE A 1 EL REGISTRO T DE SREG
	BLD			CONTROL_1, 5		; LINEA DE CONTROL 
	CBR			CONTROL,0B01000000	; LINEA DE CONTROL PARA LA FUENTE EN RUTINA RELOJ SI EL VALOR MEDIDO
	CBR			CONTROL,0B10000000	; LINEA DE CONTROL PARA LA FUENTE EN RUTINA RELOJ SI EL VALOR MEDIDO
TECLA5C2:	; OPCION 20 SEGUNDOS DE RETARDO
	CPI			R17, 0B11100111		; TECLA CALIBRAR Y MAS
	BRNE		TECLA5E				; SI NO ESTA PULSADA SALTA
	LDI			R17,retardo_inicio
	LDI			R18,1
	CALL		EEPROM_ES
LDI R18,165
STS $9A9,R18

; PARA PONER EM PANTALLA UNA M O UNA V
	SET								; PONE A CERO EL BIT T DE SREG
	BLD			CONTROL_1,5			; PASA EL REGISTRO T A CONTROL_1

TECLA5E:
LDI	R22,00
	LDI			R24,32				; PONE UN ESPACIO EN EL LUGAR DE CICLOS
	STS			$9AA,R24
	CALL		PRO_TECLA			; ACTUALIZA LA PANTALLA

TECLA5F:	;TIEMPO APAGADO EL DIGITO
	CPI			R22, RETARDO3		; VALOR DEL TIEMPO DE RATARDO LECTURA DEL TECLADO
	BRLO		TECLA5F				; COMPRUEBA EL TIEMPO DE RETARDO 
	MOV			R24,R30				; PONE EL VALOR EN R24 PARA CONVERTIRLO EN DECIMAL
	CALL		RADC   				; CONVERTIR UN NUMERO EN DIGITOS DATO EN R24
	STS			$9AA,R3				; PONE EL RESULTADO EN PANTALLA UNIDADES DE CICLOS
	CALL		PRO_TECLA
TECLA5G:
	CPI			R22, RETARDO2		; VALOR DEL TIEMPO DE RATARDO LECTURA DEL TECLADO
	BRLO		TECLA5G				; COMPRUEBA EL TIEMPO DE RETARDO 
	RJMP		TECLA5	

; ESCRIBIR LINEA 1


TECLA5H:	; PRESENTA EN LINEA 2 EL DESGASTE DEL ELECTRODO

CALL BORRAR_PANTALLA
	LDI				R16,192			; 11000000 escribir en linea 2 linea (192)
	CALL			ENVINT
	LDI				YH,HIGH(VIDA_ELECT); POSICION ALTA DEL TAXTO EN RAM 080
	LDI				YL,LOW(VIDA_ELECT)	; direccion BAJA DEL TEXTO EN RAM      	
  	LDI				R17,20 			; bytes a enviar 
	CALL			ENVIARTEXTO		; RUTINA PARA ENVIAR TEXTO EN PANNALLA
CALL NO_TECLA
	RJMP			TECLA5
