;Cuando se escribe o lee un dato en/de la (RAM de) pantalla, la Y se aumenta en 1.
;Tabla de instrucciones del S6B0108
;Instrucción RS R/W DB7 DB6 DB5 DB4 DB3 DB2 DB1 DB0 		Función
;Display 	 L  L   L   L   H   H   H   H   H  H/L 	Encender/apagar la pantalla.L: Off H: On
;ON/OFF

;POSICION	 L  L   L   H	AQUI POSICION Y  0-63
;  Y

;POSICION	 L  L   H   L   H   H   H   POS X 0-7
;  X




; CONTROL DE UN DISPLAY GRAFICO
; PUERTO DE DATOS EL PORTA
; PORT C3 Y C4 NO SE PUEDEN UTILIZAR SON PARA EL CONTROL DE LED Y TECLADO

; CS1   PC1
; CS2	PC2
; RS	PC5		; DATO A1 INSTRUCION A 0
; R/W	PC7		; A CERO ESCRIBE A 1 LEE
; E		PC6		; AL DESCENDER DATO VALIDO SIEMPRE A 1
; RST	PB4		; RESETEA EL LCD
;.EQU		RST_GRA =  ; PUERTO C
.EQU		E_GRA =   7 ; PUERTO C	; NORMAL A 1 CUANDO BAJA DATO VALIDO
;.EQU		RW_GRA  = 7 ; PUERTO C	; A CERO ESCRIBE    	A UNO LEE SIEMPRE A CERO
.EQU		RS_GRA =  5 ; PUERTO C	; A CERO INSTRUCION 	A UNO DATO	
.EQU		CS1_GRA = 2 ; PUERTO C	; A CERO SELECIONADA PARTE IZQUIERDA
.EQU		CS2_GRA = 1 ; PUERTO C


PRO_GRA: ; PROGRAMA PRINCIPAL 
; PASA EL TEXTO A IMPRIMIR A RAM PASA 128 CARACTERES O PANTALLA COMPLETA
;	LDI				ZH, HIGH (TEXTO_PRU*2)	; POSICION ALTA DEL TAXTO EN RAM 080
;	LDI				ZL, LOW  (TEXTO_PRU*2)	; direccion BAJA DEL TEXTO EN RAM  " SIN PRODUCCIO
;	LDI   			YH,0x02        	; direcion alta donde se pone el texto en RAM
;    LDI   			YL,0x40      	; direccion baja donde se pone el texto en RAM 
;	LDI				R16, 128		; MUNERO DE CARACTERES A PASAR
CARGATEXTO_GRA:
;	LPM      						; leemos TEXTO de FLASH y lo almacena en R0
;	ADIW  			ZL,1   			; apuntamos al siguiente elemento 
;	ST    			Y, R0			; guardamos en RAM POSICION Y EL CONTENIDO DE R0
;	ADIW  			YL,1      		
;	DEC   			R16      		; Hemos terminado..?? 
;	BRNE  			CARGATEXTO_GRA 	; NO...seguimos cargando 
;	NOP     						; SI...terminamos 
;	RET
	LDI				R27, 0
	LDI				R24, 16			; NUMERO DE CARACTERES A ESCRIBIR
	LDI				R24, 128		; NUMERO DE DIGITOS A ENVIAR
	LDI   			YH, 0x02		; direccion alta del TEXTO en RAM INICIAL R31
	LDI   			YL, 0x40	 	; direccion baja del TEXTO en RAM INICIAL R30
; ENCIENDE PANTALLA Y INICIA LA PRIMERA POSICION DEL TEXTO X = 0 Y = 0
; ESCRIBE CARACTERES EN PANTALLA 
; EN R27 LINEA A ESCRIBIR DE 0 A 7
; EN R24 NUMERO DE CARACTERES 0 A 128
; EN YH-YL POSICION DEL TEXTO EN RAM INICIO
; EN R26 COLUMNA DE INICIO EL PROGRAMA CARGA 0 POR DEFECTO

PRO_GRA_1:

	CALL			LOCALX_GRA		; PRIMERO ENVIAR POSICION X LUEGO LA Y
	LDI				R26, 0			; POSICION Y INICIAL DEL TEXTO
	CALL			LOCALY_GRA
	RJMP			CARGATEXTO_GRA2
CARGATEXTO_GRA1:	; POSICION SIGUIENTE DIGITO
	INC				R26
	INC				R26
	INC				R26
	INC				R26
	INC				R26
	INC				R26
	INC				R26
	INC				R26
	CALL			LOCALY_GRA
	CPI				R26, 125
	BRLO			CARGATEXTO_GRA2	
	INC				R27
	CALL			LOCALX_GRA			; PRIMERO ENVIAR POSICION X LUEGO LA Y
	LDI				R26, 0
	CALL			LOCALY_GRA
CARGATEXTO_GRA2:
; POSICION DEL TEXTO EN RAM
	LD				R16, Y+      	; carga byte en r16 e incrementa Y
	CPI				R16, 250
	BRNE			cargatexto_gra3 ; SALTA SI ES DISTINTO
	LDI				R16, 125		; CARGA ES CODIGO DE LA ñ
cargatexto_gra3:
	CPI				R16, 209
	BRNE			cargatexto_gra4 ; SALTA SI ES DISTINTO
	LDI				R16, 126		; CARGA ES CODIGO DE LA Ñ
cargatexto_gra4:
	CALL			ESCRIBIR_GRA
	DEC				R24
	BRNE			CARGATEXTO_GRA1
	RET




ENCENDER_GRA:		; ENCENDER PANTALLA GRAFICA

	CBI			PORTC, CS2_GRA		; SELECIONA PARTE DERECHA
	SBI			PORTC, CS1_GRA		; ANULA PARTE IZQUIERDA
;	CBI			PORTC, RW_GRA		; ESCRIBE
	CBI			PORTC, RS_GRA		; INSTRUCION
	LDI			R18, 0B00111111		; ENCENDER PANTALLA ES EL CODIGO
	OUT			PORTA, R18
	RCALL		RETARDO_GRA
	SBI			PORTC, CS2_GRA		; SELECIONA PARTE IZQUIERDA
	CBI			PORTC, CS1_GRA		; ANULA PARTE DERECHA
	RCALL		RETARDO_GRA
	RET

	

; ESCRIBE N CARACTERES 
; R26 POSICION Y DE O A 125
; R27 POSICION X DE 0 A 7
; R16 CODIGO ASCII A ENVIAR

; R30 Y R31 POSICION DE LOS CARACTERES EN FLASH EN CODIGO ASCI REGISTRO Z


; POSICION INICIAL DE LOS CARACTERES POSICION Y DE 0 A 127
LOCALY_GRA:
	PUSH		R26					; SALVA LA POSICION Y EN LA PILA
;	CBI			PORTC, RW_GRA		; ESCRIBE
	CBI			PORTC, RS_GRA		; INSTRUCION
	CPI			R26, 64
	BRLO		LOCALY_MENOR
	CBI			PORTC, CS2_GRA		; SELECIONA PARTE IZQUIERDA
	SBI			PORTC, CS1_GRA		; ANULA PARTE DERECA
	SUBI		R26, 64				; COMO ES MAYOR DE 64 RESTA ESTA CANTIDAD
	RJMP		LOCALY_MAYOR		; PARA ESCRIBIR EN LA PARTE DERECHA

LOCALY_MENOR:
	SBI			PORTC, CS2_GRA		; SELECIONA PARTE DERECHA
	CBI			PORTC, CS1_GRA		; ANULA PARTE IZQUIERDA
LOCALY_MAYOR:	; ENVIA LA POSICION Y DE LA LETRA		
	LDI			R18, 0B01000000		; ENCENDER PANTALLA ES EL CODIGO
	ADD			R18, R26			; LO SUMA A LA POSICION Y= 0 
	OUT			PORTA, R18
	RCALL		RETARDO_GRA
	POP			R26					; RESTAURA EL VALOR DE LA POSICION Y DE LA PILA
	RET

; POSICION INICIAL DE LOS CARACTERES POSICION X DE 0 A 8 LO GRABA EN LAS DOS PARTES
LOCALX_GRA:
;	CBI			PORTC, RW_GRA		; ESCRIBE
	CBI			PORTC, RS_GRA		; INSTRUCION
	CBI			PORTC, CS2_GRA		; SELECIONA PARTE IZQUIERDA
	SBI			PORTC, CS1_GRA		; ANULA PARTE DERECA
	LDI			R18, 0B10111000		; ENCENDER PANTALLA ES EL CODIGO
	ADD			R18, R27			; LO SUMA A LA POSICION Y= 0 
	OUT			PORTA, R18
	RCALL		RETARDO_GRA
	SBI			PORTC, CS2_GRA		; SELECIONA PARTE DERECHA
	CBI			PORTC, CS1_GRA		; ANULA PARTE IZQUIERDA
	RCALL		RETARDO_GRA
	RET

; CALCULO DE LA POSICION DEL CODIGO ASCII EN LA PLASH
; DESCONTAR 32 POR SER EL CODIGO ASCII DEL ESPACIO PRIMER CARACTER EN FLASH


ESCRIBIR_GRA:
	SBI				PORTC, RS_GRA		; SELECIONA DATOS
; ENVIAR DIGITO 5 POSICIONES MAS LOS ESPACIOS VALOR DE R29
				
    LDI   			ZH,high(TEXTO_LCD*2)	; direccion alta del TEXTO en Flash INICIAL R31
    LDI   			ZL,low(TEXTO_LCD*2) 	; direccion baja del TEXTO en Flash INICIAL R30
	SUBI			R16, 32					; RESTA 33 PARA AJUUR LA POSICION EN FLASH
	LDI				R17, 5					; MULTIPLICA POR 5 ES LA ANCHRA DE UN DIGITO
	MUL				R16, R17				; EFECTUA LA MULTIPLICACION
	ADD				ZL, R0					; SUMA EL BYT BAJO DE RESULTADO
	ADC				ZH, R1					; SUMA EL BYT ALTO MAS EL ACARREO SI LO HAY
	NOP
	NOP
	LDI				R18, 5				; ANCHURA DEL DIGITO 5X7
	MOV				R5, R18				; PASA EL VALOR A R5
GRA_TEXTO:
	LPM									; LEEMOS EL VALOR EN LA POSICION FLASH
	ADIW			ZL, 1				; INCREMENTA EN 1 LA POSICION FLASH
;COM R0									; ACTIVAR EL FONDO ENCENDIDO O APAGADO
	OUT				PORTA, R0			; PONE EL VALOR LIEDO EN FLASH EN EL PUERTO A
	RCALL			RETARDO_GRA
	DEC				R5					; DESCUENTA UNO SON 5 LINEAS POR CARACTER
	BRNE			GRA_TEXTO
	CLR				R18					; 	ESTO ES 
;COM R18								; ACTIVAR EL FONDO ENCENDIDO O APAGADO
	OUT				PORTA, R18			; 	PARA 
	RCALL			RETARDO_GRA			; 	ESCRIBIR
	RCALL			RETARDO_GRA			; 	TRES ESPACIOS
	RCALL			RETARDO_GRA
	RET

RETARDO_GRA:	; RETARDO UTILIZADO PARA ENCENDER LA PANTALLA INSTRUCION
	SBI				PORTC, E_GRA		; PONER A 1 
	LDI				R18, 1
RETARDO_GRA1:
	NOP
	NOP
	DEC				R18
	BRNE			RETARDO_GRA1
	CBI				PORTC, E_GRA		; PONER A 0
	LDI				R18, 9
RETARDO_GRA2:
	NOP
	NOP
	DEC				R18
	BRNE			RETARDO_GRA2
	NOP
	RET
; ENVIAR UNA PANTALLA ENTERA
PANTALLA:
	CALL			ENCENDER_GRA		; RUTINA PARA ACTIBAR LA PANTALLA
    LDI   			ZH,high(DIBUJO3*2)	; direccion alta del TEXTO en Flash INICIAL R31
    LDI   			ZL,low(DIBUJO3*2) 	; direccion baja del TEXTO en Flash INICIAL R30
	LDI				R18, 64				; ANCHURA DEL DIGITO 5X7
	MOV				R5, R18				; PASA EL VALOR A R5
	LDI				R27, 0
	LDI				R26, 0
	CALL			LOCALX_GRA			; PRIMERO ENVIAR POSICION X LUEGO LA Y
	CALL			LOCALY_GRA
	SBI				PORTC, RS_GRA		; SELECIONA DATOS



PANTALLA1: ; ENVIA PARTE IZQUIERDA
	LPM									; LEEMOS EL VALOR EN LA POSICION FLASH
	ADIW			ZL, 1				; INCREMENTA EN 1 LA POSICION FLASH
;COM R0									; ACTIVAR EL FONDO ENCENDIDO O APAGADO
	OUT				PORTA, R0			; PONE EL VALOR LIEDO EN FLASH EN EL PUERTO A
	RCALL			RETARDO_GRA
	DEC				R5					; DESCUENTA UNO SON 64 LINEAS
	BRNE			PANTALLA1

; SELECIONA PARTE DERECHA
	CBI				PORTC, RS_GRA		; SELECIONA INSTRUCION
	CBI				PORTC, CS2_GRA		; SELECIONA PARTE DERECHA
	SBI				PORTC, CS1_GRA		; ANULA PARTE IZQUIERDA
	RCALL			RETARDO_GRA
	CALL			LOCALX_GRA			; PRIMERO ENVIAR POSICION X LUEGO LA Y
	LDI				R26, 64				; POSICION Y INICIAL DEL TEXTO
	CALL			LOCALY_GRA
	LDI				R18, 64				; ANCHURA DEL DIGITO 5X7
	MOV				R5, R18				; PASA EL VALOR A R5
	SBI				PORTC, RS_GRA		; SELECIONA DATOS

PANTALLA2_GRA:  	; ESCRIBE PARTE DERECHA

	LPM									; LEEMOS EL VALOR EN LA POSICION FLASH
	ADIW			ZL, 1				; INCREMENTA EN 1 LA POSICION FLASH
;COM R0									; ACTIVAR EL FONDO ENCENDIDO O APAGADO
	OUT				PORTA, R0			; PONE EL VALOR LIEDO EN FLASH EN EL PUERTO A
	RCALL			RETARDO_GRA
	DEC				R5					; DESCUENTA UNO SON 64 LINEAS
	BRNE			PANTALLA2_GRA

; SELECIONA PARTE IZQUIERDA SIGUIENTE LINEA
	INC				R27
	CALL			LOCALX_GRA			; PRIMERO ENVIAR POSICION X LUEGO LA Y
	LDI				R26, 0
	CALL			LOCALY_GRA


	SBI				PORTC, RS_GRA		; SELECIONA DATOS
	LDI				R18, 64				; ANCHURA DEL DIGITO 5X7
	MOV				R5, R18				; PASA EL VALOR A R5
	CPI				R27, 8
	BRLO			PANTALLA1
	RET

